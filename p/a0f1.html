<!DOCTYPE html>
<html lang="zh">
  <head>
    
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">



  <meta name="description" content="Access Pod Metadata"/>




  <meta name="keywords" content="K8s," />


<meta name="google-site-verification" content="qy4gf0StWj627u-7aIP3WDCLBi3jPYXhm57UC7TUcok" />
<meta name="baidu-site-verification" content="XJoPG7ad2Z" />

<link rel="alternate" hreflang="x-default" href="https://zaf1ro.github.io/p/a0f1.html" />
<link rel="alternate" hreflang="zh" href="https://zaf1ro.github.io/p/a0f1.html" />




  <link rel="alternate" href="/default" title="Zaf1ro" >




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.jpeg?v=1.1" />



<link rel="canonical" href="https://zaf1ro.github.io/p/a0f1.html"/>


<meta name="description" content="1. Pass Metadata through the Downward API当container想要获取pod的metadata时, 可将metadata写入configMap&#x2F;secret中, 但这种方式存在很多问题:  修改pod配置时, 需同步更新configMap&#x2F;secret 某些metadata只有在pod创建时才能获取, 如pod的IP地址, pod何时被R">
<meta property="og:type" content="article">
<meta property="og:title" content="Access Pod Metadata">
<meta property="og:url" content="https://zaf1ro.github.io/p/a0f1.html">
<meta property="og:site_name" content="Zaf1ro">
<meta property="og:description" content="1. Pass Metadata through the Downward API当container想要获取pod的metadata时, 可将metadata写入configMap&#x2F;secret中, 但这种方式存在很多问题:  修改pod配置时, 需同步更新configMap&#x2F;secret 某些metadata只有在pod创建时才能获取, 如pod的IP地址, pod何时被R">
<meta property="og:locale">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/metadata-1-1.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/metadata-1-2.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/metadata-1-3.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/metadata-2-1.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/metadata-2-2.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/metadata-2-3.png">
<meta property="article:published_time" content="2019-11-03T14:54:49.000Z">
<meta property="article:modified_time" content="2025-03-28T21:49:53.299Z">
<meta property="article:tag" content="K8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zaf1ro.github.io/images/Kubernetes/metadata-1-1.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />




    <title>
Access Pod Metadata - Zaf1ro
</title>
  <meta name="generator" content="Hexo 6.3.0"></head>

  <body>
  <nav id="sidebar" class="active on-post">
    <div id="third">
      <div id="sidebar-title">
        <h1 id="sidebar-title-text">
            <a href="/." class="logo">Home</a>
        </h1>
      </div>
      <div id="google-search">
  <script async src="https://cse.google.com/cse.js?cx=009060789867951546370:v3hkcobeuh9"></script>
  <div class="gcse-search"></div>
</div>
      
  <div id="toc">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Pass-Metadata-through-the-Downward-API"><span class="toc-text">1. Pass Metadata through the Downward API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Expose-Metadata-through-Environment-Variables"><span class="toc-text">1.1 Expose Metadata through Environment Variables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Pass-Metadata-through-Files-in-a-DownwardAPU-Volume"><span class="toc-text">1.2 Pass Metadata through Files in a DownwardAPU Volume</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Kubernetes-API-Server"><span class="toc-text">2. Kubernetes API Server</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Explore-the-Kubernetes-REST-API"><span class="toc-text">2.1 Explore the Kubernetes REST API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Access-the-APi-Server-from-within-a-Pod"><span class="toc-text">2.2 Access the APi Server from within a Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Simplify-API-Server-Communication-with-Ambassador-Container"><span class="toc-text">2.3 Simplify API Server Communication with Ambassador Container</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Use-Client-Libraries-to-Talk-to-the-API-Server"><span class="toc-text">2.4 Use Client Libraries to Talk to the API Server</span></a></li></ol></li></ol>
  </div>

    </div>
  </nav>

    <div id="page">
      <header id="masthead"><div class="site-header-inner">
  
  <button class="nav-mobile-button on-post" id="sidebarCollapse">
  
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path d="M24 6h-24v-4h24v4zm0 4h-24v4h24v-4zm0 8h-24v4h24v-4z"/></svg>
  </button>
  
  


  <nav id="nav-top">
    
      
      <ul id="menu-top" class="nav-top-items on-post">
      
        
          <li class="menu-item">
            <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Zaf1ro">
              
              
                Github
              
            </a>
          </li>
        
      </ul>
    
  </nav>
</div>

      </header>
      <div id="content">
        
  <div class="primary">
    
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Access Pod Metadata
        
      </h1>
      <time class="post-time">
          11/03/19
      </time>
    </header>

    <div class="post-content">
      <h2 id="1-Pass-Metadata-through-the-Downward-API"><a href="#1-Pass-Metadata-through-the-Downward-API" class="headerlink" title="1. Pass Metadata through the Downward API"></a>1. Pass Metadata through the Downward API</h2><p>当container想要获取pod的metadata时, 可将metadata写入configMap&#x2F;secret中, 但这种方式存在很多问题:</p>
<ul>
<li>修改pod配置时, 需同步更新configMap&#x2F;secret</li>
<li>某些metadata只有在pod创建时才能获取, 如pod的IP地址, pod何时被ReplicaSet创建, 但pod创建后无法修改configMap&#x2F;secret</li>
<li>某些metadata已经存在于pod的资源清单(manifest file)中, 如label或annotation, 需将这些信息重新写入configMap&#x2F;secret中</li>
</ul>
<p>为解决上述问题, k8s提供<strong>Downward API</strong>让pod中的container可直接获取pod的metadata. Downward API并不是一个REST API, 它会将指定的metadata导入<strong>环境变量</strong>或<strong>volume</strong>中.<br><img src="/images/Kubernetes/metadata-1-1.png" alt="The Downward API exposes pod metadata through environment variables or files"></p>
<p>以下是Downward API包含的pod metadata:</p>
<ul>
<li>pod的名字</li>
<li>pod的IP地址</li>
<li>pod所属的namespace</li>
<li>pod所在的worker node名字</li>
<li>pod所属的service名字</li>
<li>每个container的requested CPU&#x2F;memory</li>
<li>每个container的CPU&#x2F;memory limit</li>
<li>pod的label</li>
<li>pod的annotation</li>
</ul>
<p>以下是request CPU&#x2F;memory和CPU&#x2F;memory limit的区别:</p>
<ul>
<li>Requested CPU&#x2F;memory: 表示该container申请的资源数量, 但并不意味着container一定拥有这些资源. 例如, 一个container申请200mb内存, 但只使用100mb内存, 那么剩下的100mb会在其他container的需求超出其请求资源时借给其他container.</li>
<li>CPU&#x2F;memory limit: 表示该container的资源上限, 当一个container获取的资源超出该值时, 会被强制终止</li>
</ul>
<p>总结一下, <strong>CPU&#x2F;memory limit</strong>等于<strong>requested CPU&#x2F;memory</strong>加上<strong>从其他container借来的CPU&#x2F;memory</strong>. requested CPU&#x2F;memory表示container通常情况下需要多少资源, CPU&#x2F;memory limit表示container可拥有的最大资源量.</p>
<p>上述大部分metadata都可通过<strong>环境变量</strong>或<strong>volume</strong>获取, 但label和annotation只能通过<strong>volume</strong>获取, 因为:</p>
<ul>
<li>label或annotation通常包含一个或多个键值对, 无法放入单个环境变量</li>
<li>label或annotation可在pod运行时被修改, 而环境变量一旦初始化则无法修改</li>
</ul>
<h3 id="1-1-Expose-Metadata-through-Environment-Variables"><a href="#1-1-Expose-Metadata-through-Environment-Variables" class="headerlink" title="1.1 Expose Metadata through Environment Variables"></a>1.1 Expose Metadata through Environment Variables</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">downward</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;9999999&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">15m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">100Ki</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">4Mi</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVICE_ACCOUNT</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">spec.serviceAccountName</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONTAINER_CPU_REQUEST_MILLICORES</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">resourceFieldRef:</span></span><br><span class="line">        <span class="attr">resource:</span> <span class="string">requests.cpu</span></span><br><span class="line">        <span class="attr">divisor:</span> <span class="string">1m</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONTAINER_MEMORY_LIMIT_KIBIBYTES</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">resourceFieldRef:</span></span><br><span class="line">        <span class="attr">resource:</span> <span class="string">limits.memory</span></span><br><span class="line">        <span class="attr">divisor:</span> <span class="string">1Ki</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Kubernetes/metadata-1-2.png" alt="Pod metadata and attributes can be exposed to the pod through environment variables"></p>
<p>上述YAML文件中将pod的metadata放入环境变量. 其中, requested CPU&#x2F;memory和CPU&#x2F;memory limit需标注一个额外参数<strong>divisor</strong>, 其表示资源单位:</p>
<ul>
<li>CPU的单位为<strong>millicore</strong>, 表示千分之一的CPU单元(CPU core). 本例中, divisor为1m, 环境变量中<code>CONTAINER_CPU_REQUEST_MILLICORES</code>为15, 表示该container请求了1.5%的CPU</li>
<li>Memory的单位为<strong>Kibibtye</strong>, 表示一千字节. 本例中, divisor为1Ki, 环境变量中<code>CONTAINER_MEMORY_LIMIT_KIBIBYTES</code>为4096, 表示该container的内存上限为4Mi.</li>
</ul>
<p>进入pod可查看环境变量:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> downward <span class="built_in">env</span></span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">HOSTNAME=downward</span><br><span class="line">CONTAINER_MEMORY_LIMIT_KIBIBYTES=4096</span><br><span class="line">POD_NAME=downward</span><br><span class="line">POD_NAMESPACE=default</span><br><span class="line">POD_IP=10.0.0.10</span><br><span class="line">NODE_NAME=gke-kubia-default-pool-32a2cac8-sgl7</span><br><span class="line">SERVICE_ACCOUNT=default</span><br><span class="line">CONTAINER_CPU_REQUEST_MILLICORES=15</span><br><span class="line">KUBERNETES_SERVICE_HOST=10.3.240.1</span><br><span class="line">KUBERNETES_SERVICE_PORT=443</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="1-2-Pass-Metadata-through-Files-in-a-DownwardAPU-Volume"><a href="#1-2-Pass-Metadata-through-Files-in-a-DownwardAPU-Volume" class="headerlink" title="1.2 Pass Metadata through Files in a DownwardAPU Volume"></a>1.2 Pass Metadata through Files in a DownwardAPU Volume</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">downward</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">foo:</span> <span class="string">bar</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">key1:</span> <span class="string">value1</span></span><br><span class="line">    <span class="attr">key2:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      multi</span></span><br><span class="line"><span class="string">      line</span></span><br><span class="line"><span class="string">      value</span></span><br><span class="line"><span class="string"></span><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;9999999&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">15m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">100Ki</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">4Mi</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">downward</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/downward</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">downward</span></span><br><span class="line">    <span class="attr">downwardAPI:</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;podName&quot;</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;podNamespace&quot;</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;labels&quot;</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.labels</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;annotations&quot;</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.annotations</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;containerCpuRequestMilliCores&quot;</span></span><br><span class="line">        <span class="attr">resourceFieldRef:</span></span><br><span class="line">          <span class="attr">containerName:</span> <span class="string">main</span></span><br><span class="line">          <span class="attr">resource:</span> <span class="string">requests.cpu</span></span><br><span class="line">          <span class="attr">divisor:</span> <span class="string">1m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;containerMemoryLimitBytes&quot;</span></span><br><span class="line">        <span class="attr">resourceFieldRef:</span></span><br><span class="line">          <span class="attr">containerName:</span> <span class="string">main</span></span><br><span class="line">          <span class="attr">resource:</span> <span class="string">limits.memory</span></span><br><span class="line">          <span class="attr">divisor:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>上述YAML文件将metadata挂靠在<code>/etc/downward</code>下. 如下图:<br><img src="/images/Kubernetes/metadata-1-3.png" alt="Use a downwardAPI volume to pass metadata to the container"></p>
<p>需要注意的是, 当在volume中使用requested CPU&#x2F;memory或CPU&#x2F;memory limit时, 需标注container名字, 因为每个container有不同的request和limit.</p>
<h2 id="2-Kubernetes-API-Server"><a href="#2-Kubernetes-API-Server" class="headerlink" title="2. Kubernetes API Server"></a>2. Kubernetes API Server</h2><p>Downward API虽然能为container提供当前pod的metadata, 但若container需要访问pod之外的信息, 可通过环境变量获取service相关的信息, 但如果是其他信息, 则只能需要访问K8s API server.</p>
<p><img src="/images/Kubernetes/metadata-2-1.png" alt="Talking to the API server from inside a pod to get information about other API objects"></p>
<h3 id="2-1-Explore-the-Kubernetes-REST-API"><a href="#2-1-Explore-the-Kubernetes-REST-API" class="headerlink" title="2.1 Explore the Kubernetes REST API"></a>2.1 Explore the Kubernetes REST API</h3><p>向k8s API发送请求前需要先了解这套API:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl cluster-info</span><br><span class="line">Kubernetes master is running at https://192.168.99.100:8443</span><br></pre></td></tr></table></figure>
<p>由于API server使用<strong>HTTPS</strong>, 因此无法直接访问:</p>
<ul>
<li>访问前进行HTTPS认证</li>
<li>使用kubectl proxy命令启动一个proxy server, 由于proxy server接受HTTP连接, 因此container可借助proxy server与API server通信</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl proxy</span><br><span class="line">Starting to serve on 127.0.0.1:8001</span><br></pre></td></tr></table></figure>
<p>该命令会自动获取所有需要的信息(API server URL, authorization token等). Proxy server监听8001端口.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ curl http://localhost:8001</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;paths&quot;</span>: [</span><br><span class="line">  <span class="string">&quot;/api&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/api/v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/apis&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/apis/apps&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/apis/apps/v1beta1&quot;</span>,</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">&quot;/apis/batch&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/apis/batch/v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/apis/batch/v2alpha1&quot;</span>,</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>上述每一行都是一个<strong>API group</strong>, 每一个API Group关联一个或多个k8s resource. API group可分为以下两类:</p>
<ul>
<li>core group: 包含一些核心资源, 如pod, node, namespace, service, secret, volume, configMap等, URL路径为&#x2F;<code>api/v1</code>, 对应manifest中的<code>apiVersion: v1</code></li>
<li>named groups: 包含一些K8s的拓展功能, URL路径为<code>/apis/&lt;GROUP_NAME\&gt;/&lt;VERSION&gt;</code>, :、对应manifest中的<code>apiVersion: GROUP_NAME/VERSION</code></li>
</ul>
<p>以下是named group的一些例子:</p>
<ul>
<li>&#x2F;apis&#x2F;apps: Deployment, ReplicaSet, StatefulSet, DaemonSet</li>
<li>&#x2F;apis&#x2F;extensions: Ingress, NetworkPolicies, PodSecurityPolicies</li>
<li>&#x2F;apis&#x2F;batch: Job, CronJob</li>
<li>&#x2F;apis&#x2F;storage.k8s.io: StorageClass, VolumeAttachment</li>
<li>&#x2F;apis&#x2F;policy: PodDisruptionBudget</li>
</ul>
<p>以Job为例, 其位于<code>/api/batch</code>的路径上:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ curl http://localhost:8001/apis/batch</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;APIGroup&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;batch&quot;</span>,</span><br><span class="line">  <span class="string">&quot;versions&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;groupVersion&quot;</span>: <span class="string">&quot;batch/v1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;version&quot;</span>: <span class="string">&quot;v1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;groupVersion&quot;</span>: <span class="string">&quot;batch/v2alpha1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;version&quot;</span>: <span class="string">&quot;v2alpha1&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;preferredVersion&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;groupVersion&quot;</span>: <span class="string">&quot;batch/v1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;v1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;serverAddressByClientCIDRs&quot;</span>: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述为batch API group的描述, 包括version和其他信息. 以下是&#x2F;api&#x2F;batch&#x2F;v1的路径访问结果:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ curl http://localhost:8001/apis/batch/v1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;APIResourceList&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;groupVersion&quot;</span>: <span class="string">&quot;batch/v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;resources&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;jobs&quot;</span>,</span><br><span class="line">      <span class="string">&quot;namespaced&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;Job&quot;</span>,</span><br><span class="line">      <span class="string">&quot;verbs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;create&quot;</span>,</span><br><span class="line">        <span class="string">&quot;delete&quot;</span>,</span><br><span class="line">        <span class="string">&quot;deletecollection&quot;</span>,</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span>,</span><br><span class="line">        <span class="string">&quot;patch&quot;</span>,</span><br><span class="line">        <span class="string">&quot;update&quot;</span>,</span><br><span class="line">        <span class="string">&quot;watch&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;jobs/status&quot;</span>,</span><br><span class="line">      <span class="string">&quot;namespaced&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;Job&quot;</span>,</span><br><span class="line">      <span class="string">&quot;verbs&quot;</span>:</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;patch&quot;</span>,</span><br><span class="line">        <span class="string">&quot;update&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>name</code>表示可访问的路径, <code>kind</code>表示所属resource类型, <code>namespaced</code>表示该资源为全局资源或仅限于某个namespace, <code>verbs</code>表示可进行的操作类别, 以下是所有操作类别与其对应的HTTP方法:</p>
<ul>
<li>create: 创建一个resource object, 如<code>POST /resourceURL</code></li>
<li>update: 更新已有resource object, 如<code>PUT /resourceURL/name</code></li>
<li>patch: 部分更新已有resource object, 如<code>PATCH /resourceURL/name</code></li>
<li>get: 获取特定resource object, 如<code>GET /resourceURL/name</code></li>
<li>list: 获得所有符合selector规则的resource object集合, 如G<code>ET /resourceURL</code></li>
<li>watch: 监视某个resource object或某个resource object集合, 如G<code>ET /resourceURL?watch=true</code></li>
<li>delete: 删除某个resource object, 如<code>DELETE /resourceURL/name</code></li>
<li>deletecollection: 删除某个resource object集合, 如<code>DELETE /resourceURL</code></li>
</ul>
<p>向&#x2F;apis&#x2F;batch&#x2F;v1&#x2F;jobs发送GET请求可获得当前cluster中所有job:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ curl http://localhost:8001/apis/batch/v1/jobs</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;JobList&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;batch/v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;selfLink&quot;</span>: <span class="string">&quot;/apis/batch/v1/jobs&quot;</span>,</span><br><span class="line">    <span class="string">&quot;resourceVersion&quot;</span>: <span class="string">&quot;225162&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;items&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;my-job&quot;</span>,</span><br><span class="line">        <span class="string">&quot;namespace&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>也可通过namespace和job名称获取该job的详细信息:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ curl http://localhost:8001/apis/batch/v1/namespaces/default/jobs/my-job</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;Job&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;batch/v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;my-job&quot;</span>,</span><br><span class="line">    <span class="string">&quot;namespace&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>可以发现, 上述输出与执行kubectl get job my-job -o json的结果相同.</p>
<h3 id="2-2-Access-the-APi-Server-from-within-a-Pod"><a href="#2-2-Access-the-APi-Server-from-within-a-Pod" class="headerlink" title="2.2 Access the APi Server from within a Pod"></a>2.2 Access the APi Server from within a Pod</h3><p>上述与API server沟通的方式仅限于node中, 由于container中无法调用kubectl, 因此无法创建proxy server.  若想要在container中与API server通讯, 需满足以下三个条件:</p>
<ul>
<li>获取API server的IP address</li>
<li>保证对方为API server, 而不是其他人</li>
<li>与API server进行身份验证, 否则API server不会处理任何请求</li>
</ul>
<p>为展示整个流程, 我们可运行一个不执行任何操作的pod, 其已包含curl程序, 以下是该pod的manifest:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">curl</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tutum/curl</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;9999999&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>执行<code>kubectl exec -it curl bash</code>可在container中执行一个bash shell. 首先我们需要获取API server的IP地址, k8s会在<code>default</code>的namespace中自动启动一个service, 名为<strong>kubernetes</strong>, 其包含API server的IP地址和端口号:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc</span><br><span class="line">NAME        CLUSTER-IP  EXTERNAL-IP PORT(S) AGE</span><br><span class="line">kubernetes  10.0.0.1    &lt;none&gt;      443/TCP 46d</span><br></pre></td></tr></table></figure>

<p>container的环境变量也包含API server的IP地址和端口号:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@curl:/# <span class="built_in">env</span> | grep KUBERNETES_SERVICE</span><br><span class="line">KUBERNETES_SERVICE_PORT=443</span><br><span class="line">KUBERNETES_SERVICE_HOST=10.0.0.1</span><br><span class="line">KUBERNETES_SERVICE_PORT_HTTPS=443</span><br></pre></td></tr></table></figure>

<p>实际上我们不需要知道API server的IP地址和端口号, 直接访问<code>https://kubernetes</code>即可:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@curl:/# curl https://kubernetes</span><br><span class="line">curl: (60) SSL certificate problem: unable to get <span class="built_in">local</span> issuer certificate</span><br><span class="line">...</span><br><span class="line">If you<span class="string">&#x27;d like to turn off curl&#x27;</span>s verification of the certificate, use</span><br><span class="line"> the -k (or --insecure) option.</span><br></pre></td></tr></table></figure>

<p>接下来需要验证API server身份: k8s集群中每个container都默认挂载一个secret, 挂载在<code>/var/run/secrets/kubernetes.io/serviceaccount/</code>:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@curl:/# <span class="built_in">ls</span> /var/run/secrets/kubernetes.io/serviceaccount/</span><br><span class="line">ca.crt namespace token</span><br></pre></td></tr></table></figure>

<ul>
<li>ca.crt: CA证书, 用于验证其他证书</li>
<li>namespace: 当前pod所在的namespace名称</li>
<li>token: 用于向API server进行身份验证</li>
</ul>
<p>使用ca.crt连接API server:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@curl:/# curl --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt https://kubernetes</span><br><span class="line">Unauthorized</span><br></pre></td></tr></table></figure>
<p>curl成功验证了API server的身份, 但curl并没有向API server进行身份验证, 因此需要在请求加入token:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@curl:/# TOKEN=$(<span class="built_in">cat</span> /var/run/secrets/kubernetes.io/serviceaccount/token)</span><br><span class="line">root@curl:/# curl -H <span class="string">&quot;Authorization: Bearer <span class="variable">$TOKEN</span>&quot;</span> https://kubernetes</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;paths&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;/api&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/api/v1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/apis&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/apis/apps&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/apis/apps/v1beta1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/apis/authorization.k8s.io&quot;</span>,</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&quot;/ui/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/version&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自此container与API server成功建立连接, 当container向API server查询或修改某个资源时, 需要标注namespace, 因此可将secret volume中<strong>namespace</strong>文件导入到环境变量中:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root@curl:/# NS=$(<span class="built_in">cat</span> /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span><br><span class="line">root@curl:/# curl -H <span class="string">&quot;Authorization: Bearer <span class="variable">$TOKEN</span>&quot;</span> https://kubernetes/api/v1/namespaces/<span class="variable">$NS</span>/pods</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;PodList&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>整个流程如下图:<br><img src="/images/Kubernetes/metadata-2-2.png" alt="Use the files from the default-token Secret to talk to the API server"></p>
<h3 id="2-3-Simplify-API-Server-Communication-with-Ambassador-Container"><a href="#2-3-Simplify-API-Server-Communication-with-Ambassador-Container" class="headerlink" title="2.3 Simplify API Server Communication with Ambassador Container"></a>2.3 Simplify API Server Communication with Ambassador Container</h3><p>上述步骤虽然实现了container与API server通信, 但操作过于复杂, 因此可使用Sidecar Pattern: 运行一个<strong>ambassador container</strong>作为代理, 作为container与API server的中间代理.</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">curl-with-ambassador</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tutum/curl</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;9999999&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ambassador</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">luksa/kubectl-proxy:1.6.2</span> </span><br></pre></td></tr></table></figure>
<p>上述YAML文件创建了一个pod, 其包含两个container: 主程序main和代理程序ambassador. Ambassador接收请求并转发给API server, 这样main不需要配置任何certificate和token.</p>
<p><img src="/images/Kubernetes/metadata-2-3.png" alt="Offload encryption, authentication, and server verification in an ambassador container"></p>
<h3 id="2-4-Use-Client-Libraries-to-Talk-to-the-API-Server"><a href="#2-4-Use-Client-Libraries-to-Talk-to-the-API-Server" class="headerlink" title="2.4 Use Client Libraries to Talk to the API Server"></a>2.4 Use Client Libraries to Talk to the API Server</h3><p>除了ambassador, K8s官方还为以下两种语言提供了API Client Libraries:</p>
<ul>
<li>Golang client—<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/kubernetes/client-go">https://github.com/kubernetes/client-go</a></li>
<li>Python—<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/kubernetes-incubator/client-python">https://github.com/kubernetes-incubator/client-python</a></li>
</ul>
<p>以下为其他语言的API Client Libraries:</p>
<ul>
<li>Java client by Fabric8—<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/fabric8io/kubernetes-client">https://github.com/fabric8io/kubernetes-client</a></li>
<li>Node.js client by tenxcloud—<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/tenxcloud/node-kubernetes-client">https://github.com/tenxcloud/node-kubernetes-client</a></li>
<li>PHP—<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/devstub/kubernetes-api-php-client">https://github.com/devstub/kubernetes-api-php-client</a></li>
<li>Ruby—<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Ch00k/kubr">https://github.com/Ch00k/kubr</a></li>
<li>Clojure—<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/yanatan16/clj-kubernetes-api">https://github.com/yanatan16/clj-kubernetes-api</a></li>
<li>Scala—<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/doriordan/skuber">https://github.com/doriordan/skuber</a></li>
<li>Perl—<a target="_blank" rel="noopener external nofollow noreferrer" href="https://metacpan.org/pod/Net::Kubernetes">https://metacpan.org/pod/Net::Kubernetes</a></li>
</ul>

    </div>

    <footer class="post-footer">
      
      <div class="post-tags">
        
          <a href="/tags/K8s/">K8s</a>
        
      </div>
      

      
      
  <nav class="post-nav">
    
      <a class="prev" href="/p/10cb.html">
        <i class="icon-left"></i>
        <span class="prev-text nav-default">Deployment</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/p/95.html">
        <span class="next-text nav-default">ConfigMap and Secret</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="icon-right"></i>
      </a>
    
  </nav>

      
    </footer>
  </article>

  </div>
  
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    showProcessingMessages: true,
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: false,
        skipTags: ["script","noscript","style","textarea"]
    },
    TeX: {
        Macros:{
            Arr: ["\\{ #1 \\}", 1],
            fi: "{f\\,\\!_i}",
            SS: ["{#1\\:\\!_#2}",2],
            SUBx: ["{\\:\\!_#1}",1],
            EXPx: ["{\\;\\!^#1}",1],
            Ss: ["{#1\\,\\!_#2}",2],
            subx: ["{\\,\\!_#1}",1]
        }
    }
});
</script>


      </div>
    </div>

    
<script type="text/javascript">
  var disqus_shortname = 'zaf1ro';
  var disqus_identifier = 'p/a0f1.html';
  var disqus_title = "Access Pod Metadata";

  var disqus = {
    load : function disqus(){
        if(typeof DISQUS !== 'object') {
          (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
          }());
          $('#load-disqus').remove(); ///加载后移除按钮
        }
    }
  }

  
    var disqus_config = function () {
        this.page.url = disqus_url;
        this.page.identifier = disqus_identifier;
        this.page.title = disqus_title;
    };
  

</script>



    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.6.0.min.js"></script>
  

  

    
    <script type="text/javascript">
(function(){"use strict";var Theme={};Theme.backToTop={register:function(){var $backToTop=$('#back-to-top');$(window).scroll(function(){if($(window).scrollTop()>100){$backToTop.fadeIn(1000)}else{$backToTop.fadeOut(1000)}});$backToTop.click(function(){$('body').animate({scrollTop:0})})}};Theme.fancybox={register:function(){if($.fancybox){$('.post').each(function(){$(this).find('img').each(function(){$(this).wrap('<a class="fancybox" href="'+this.src+'" title="'+this.alt+'"></a>')})});$('.fancybox').fancybox({openEffect:'elastic',closeEffect:'elastic'})}}};this.Theme=Theme}.call(this));
</script>

<script type="text/javascript">
$(document).ready(function(){if(themeConfig.fancybox.enable){Theme.fancybox.register()}Theme.backToTop.register()});
</script>
    
<script type="text/javascript">
var themeConfig = {
  fancybox: {
    enable: false
  },
};
</script>

    <script>
    $('table').wrap('<div style="overflow-x: auto;"></div>');
</script>
    
    <script>
$(document).ready(function () {
    $('#sidebarCollapse').on('click', function(){
        $('#sidebar').toggleClass('active');
    });

    $('#toc ol li a').on('click', function(){
        $('#sidebar').toggleClass('active');
    });
});
</script>
  </body>
</html>
