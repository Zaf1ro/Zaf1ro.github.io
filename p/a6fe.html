<!DOCTYPE html>
<html lang="zh">
  <head>
    
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">



  <meta name="description" content="Why Use DDD"/>




  <meta name="keywords" content="Microservices," />


<meta name="google-site-verification" content="qy4gf0StWj627u-7aIP3WDCLBi3jPYXhm57UC7TUcok" />
<meta name="baidu-site-verification" content="XJoPG7ad2Z" />

<link rel="alternate" hreflang="x-default" href="https://zaf1ro.github.io/p/a6fe.html" />
<link rel="alternate" hreflang="zh" href="https://zaf1ro.github.io/p/a6fe.html" />




  <link rel="alternate" href="/default" title="Zaf1ro" >




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.jpeg?v=1.1" />



<link rel="canonical" href="https://zaf1ro.github.io/p/a6fe.html"/>


<meta name="description" content="1. What is ArchitectureArchitecture(架构)的概念来自于土木工程中的&quot;建筑&quot;和&quot;结构&quot;, 在软件开发中更多地指代那些代码机构, 设计模式, 规范和组件间的通信方式. 一个好的架构, 应满足以下几个目标:  独立于框架: 架构不应该依赖某个外部的库或框架 独立于UI: 前端展示随时发生变化, 但是底层架构不应该随之改变 独立于">
<meta property="og:type" content="article">
<meta property="og:title" content="Why Use DDD">
<meta property="og:url" content="https://zaf1ro.github.io/p/a6fe.html">
<meta property="og:site_name" content="Zaf1ro">
<meta property="og:description" content="1. What is ArchitectureArchitecture(架构)的概念来自于土木工程中的&quot;建筑&quot;和&quot;结构&quot;, 在软件开发中更多地指代那些代码机构, 设计模式, 规范和组件间的通信方式. 一个好的架构, 应满足以下几个目标:  独立于框架: 架构不应该依赖某个外部的库或框架 独立于UI: 前端展示随时发生变化, 但是底层架构不应该随之改变 独立于">
<meta property="og:locale">
<meta property="article:published_time" content="2020-12-29T15:54:02.000Z">
<meta property="article:modified_time" content="2024-08-20T16:43:04.037Z">
<meta property="article:tag" content="Microservices">
<meta name="twitter:card" content="summary">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />




    <title>
Why Use DDD - Zaf1ro
</title>
  <meta name="generator" content="Hexo 6.3.0"></head>

  <body>
  <nav id="sidebar" class="active on-post">
    <div id="third">
      <div id="sidebar-title">
        <h1 id="sidebar-title-text">
            <a href="/." class="logo">Home</a>
        </h1>
      </div>
      <div id="google-search">
  <script async src="https://cse.google.com/cse.js?cx=009060789867951546370:v3hkcobeuh9"></script>
  <div class="gcse-search"></div>
</div>
      
  <div id="toc">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-What-is-Architecture"><span class="toc-text">1. What is Architecture</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Transaction-Script"><span class="toc-text">2. Transaction Script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Maintainability"><span class="toc-text">3. Maintainability</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Scalability"><span class="toc-text">4. Scalability</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Testability"><span class="toc-text">5. Testability</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Summary-of-Problems"><span class="toc-text">6. Summary of Problems</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-What-is-DDD"><span class="toc-text">7. What is DDD</span></a></li></ol>
  </div>

    </div>
  </nav>

    <div id="page">
      <header id="masthead"><div class="site-header-inner">
  
  <button class="nav-mobile-button on-post" id="sidebarCollapse">
  
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path d="M24 6h-24v-4h24v4zm0 4h-24v4h24v-4zm0 8h-24v4h24v-4z"/></svg>
  </button>
  
  


  <nav id="nav-top">
    
      
      <ul id="menu-top" class="nav-top-items on-post">
      
        
          <li class="menu-item">
            <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Zaf1ro">
              
              
                Github
              
            </a>
          </li>
        
      </ul>
    
  </nav>
</div>

      </header>
      <div id="content">
        
  <div class="primary">
    
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Why Use DDD
        
      </h1>
      <time class="post-time">
          12/29/20
      </time>
    </header>

    <div class="post-content">
      <h2 id="1-What-is-Architecture"><a href="#1-What-is-Architecture" class="headerlink" title="1. What is Architecture"></a>1. What is Architecture</h2><p>Architecture(架构)的概念来自于土木工程中的&quot;建筑&quot;和&quot;结构&quot;, 在软件开发中更多地指代那些代码机构, 设计模式, 规范和组件间的通信方式. 一个好的架构, 应满足以下几个目标:</p>
<ul>
<li>独立于框架: 架构不应该依赖某个外部的库或框架</li>
<li>独立于UI: 前端展示随时发生变化, 但是底层架构不应该随之改变</li>
<li>独立于底层数据源: 无论今天你用MySQL, MongoDB, 还是文件系统, 架构都不应产生巨大改变</li>
<li>独立于外部依赖: 无论外部依赖如何变更, 升级, 业务的核心逻辑不应该随之而大幅变化</li>
<li>可测试: 无论外部依赖了什么样的硬件, UI或者服务, 业务的逻辑应该都能够快速被验证正确性</li>
</ul>
<h2 id="2-Transaction-Script"><a href="#2-Transaction-Script" class="headerlink" title="2. Transaction Script"></a>2. Transaction Script</h2><p>假设我们现在要实现一个银行转账功能, 支持跨币种, 基本需求可以拆解成以下几个步骤:</p>
<ol>
<li>从MySQL中找到转入和转出账户, 选择用MyBatis的mapper实现DAO</li>
<li>从Yahoo(或其他渠道)获得当前汇率信息</li>
<li>确保转出账户上有足够的约, 且未超出每日转账上限</li>
<li>实现转入转出, 扣除手续费, 保存数据库</li>
<li>发送Kafka审计信息, 以便后续审计和对账</li>
</ol>
<p>代码实现如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransferController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> TransferService transferService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">transfer</span><span class="params">(String targetAccountNumber, BigDecimal amount, HttpSession session)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> (Long) session.getAttribute(<span class="string">&quot;userId&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> transferService.transfer(userId, targetAccountNumber, amount, <span class="string">&quot;CNY&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransferServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">TransferService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC_AUDIT_LOG</span> <span class="operator">=</span> <span class="string">&quot;TOPIC_AUDIT_LOG&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountDAO;</span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    <span class="keyword">private</span> YahooForexService yahooForex;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">transfer</span><span class="params">(Long sourceUserId, String targetAccountNumber, BigDecimal targetAmount, String targetCurrency)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 从数据库读取数据，忽略所有校验逻辑如账号是否存在等</span></span><br><span class="line">        <span class="type">AccountDO</span> <span class="variable">sourceAccountDO</span> <span class="operator">=</span> accountDAO.selectByUserId(sourceUserId);</span><br><span class="line">        <span class="type">AccountDO</span> <span class="variable">targetAccountDO</span> <span class="operator">=</span> accountDAO.selectByAccountNumber(targetAccountNumber);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 业务参数校验</span></span><br><span class="line">        <span class="keyword">if</span> (!targetAccountDO.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidCurrencyException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 获取外部数据，并且包含一定的业务逻辑</span></span><br><span class="line">        <span class="comment">// exchange rate = 1 source currency = X target currency</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">exchangeRate</span> <span class="operator">=</span> BigDecimal.ONE;</span><br><span class="line">        <span class="keyword">if</span> (sourceAccountDO.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">            exchangeRate = yahooForex.getExchangeRate(sourceAccountDO.getCurrency(), targetCurrency);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">sourceAmount</span> <span class="operator">=</span> targetAmount.divide(exchangeRate, RoundingMode.DOWN);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 业务参数校验</span></span><br><span class="line">        <span class="keyword">if</span> (sourceAccountDO.getAvailable().compareTo(sourceAmount) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InsufficientFundsException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sourceAccountDO.getDailyLimit().compareTo(sourceAmount) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DailyLimitExceededException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 计算新值，并且更新字段</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">newSource</span> <span class="operator">=</span> sourceAccountDO.getAvailable().subtract(sourceAmount);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">newTarget</span> <span class="operator">=</span> targetAccountDO.getAvailable().add(targetAmount);</span><br><span class="line">        sourceAccountDO.setAvailable(newSource);</span><br><span class="line">        targetAccountDO.setAvailable(newTarget);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 更新到数据库</span></span><br><span class="line">        accountDAO.update(sourceAccountDO);</span><br><span class="line">        accountDAO.update(targetAccountDO);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 发送审计消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> sourceUserId + <span class="string">&quot;,&quot;</span> + targetAccountNumber + <span class="string">&quot;,&quot;</span> + targetAmount + <span class="string">&quot;,&quot;</span> + targetCurrency;</span><br><span class="line">        kafkaTemplate.send(TOPIC_AUDIT_LOG, message);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到, 这段代码包含了多个功能: 参数校验, 数据读取和存储, 业务处理, 调用外部服务, 发送信息. 真实开发中可能会将代码拆分到多个函数中, 但实际效果类似. 这种代码称为<strong>Spaghetti Code</strong>(面条式代码)和<strong>Transaction Script</strong>(事务脚本)和, 这种pattern对于小型应用没有问题, 可以快速实现业务功能; 但对于大型项目来说, 存在诸多问题.</p>
<h2 id="3-Maintainability"><a href="#3-Maintainability" class="headerlink" title="3. Maintainability"></a>3. Maintainability</h2><p>评判可维护性, 取决于依赖发生变化时, 有多少代码需要随之更改. 需要修改的越少, 则可维护性越强. 上述代码之所以可维护性差, 因为以下几点:</p>
<ul>
<li>数据结构不稳定: AccountDO映射数据库中一个table, 数据库的sharding, table重设计, 或table中字段重命名都会影响该数据结构</li>
<li>依赖库升级: 上述代码使用到了MyBatis, 若MyBatis升级迭代, 可能造成某些功能发生改变. 无论是升级MyBatis或更换ORM, 成本都很巨大.</li>
<li>第三方服务依赖: 上述代码使用Yahoo作为汇率服务, 外部服务的任何变化都会影响代码的运行, 如签名的更换, 服务的不可用, 服务功能的更改.</li>
<li>中间件更换: 上述代码使用Kafka传输信息, 但若以后更改为其他MQ, 则需要大量修改.</li>
</ul>
<h2 id="4-Scalability"><a href="#4-Scalability" class="headerlink" title="4. Scalability"></a>4. Scalability</h2><p>评判可拓展性, 取决于当添加新的业务逻辑时, 需要新增或修改多少代码. 假设需要添加一个跨行转账的功能, 你会发现上述代码基本无法复用:</p>
<ul>
<li>数据来源和数据格式: 上述代码的数据源为AccountDO, 而跨行需要从第三方服务获取, 服务间的数据格式也不可能兼容, 导致数据校验, 读写和异常处理都需要重写</li>
<li>业务逻辑: 数据格式的更改导致业务逻辑无法兼容, 最终导致代码充满if-else语句, 而越发复杂的分支逻辑最终加重开发和维护成本, 且容易造成bug</li>
<li>数据存储: 当业务逻辑变得复杂后, 新加入的逻辑可能需要对数据库schema或消息格式做出变更, 从而导致底层实现跟着重构</li>
</ul>
<h2 id="5-Testability"><a href="#5-Testability" class="headerlink" title="5. Testability"></a>5. Testability</h2><p>可测试性取决于两方面, 测试的覆盖度和测试的自动化程度. 高覆盖率会提高代码中错误出现的概率, 高自动化程度会提高测试的效率. 然而对于上述代码, 存在诸多测试的障碍:</p>
<ul>
<li>测试搭建困难: 当代码中存在对数据库, 第三方服务, 中间体等外部依赖时, 想要完整测试整个项目需要所有外部服务都能跑起来</li>
<li>测试时长: 很多外部依赖属于I&#x2F;O操作, 如网络请求和磁盘调度. 这种I&#x2F;O调度在测试中耗时很久, 导致测试很难及时推进</li>
<li>耦合度高: 若某段代码中存在M个步骤, 每个步骤存在N种状态. 当所有步骤相互耦合时, 为了覆盖所有用例, 则需要有$M^N$个测试用例. 随着耦合步骤的增加, 测试用例的数量呈指数级增长.</li>
</ul>
<h2 id="6-Summary-of-Problems"><a href="#6-Summary-of-Problems" class="headerlink" title="6. Summary of Problems"></a>6. Summary of Problems</h2><p>之所以出现上述问题, 主要因为上述代码违反了以下几个原则:</p>
<ul>
<li>Single Responsibility Principle(单一性原则): 一个class只应有一个职责, 该职责被封装在class中. 换句话说, 改变class代码的原因只能有一个. 例如: 新闻编辑和报刊排版, 一个是文章的修改, 一个是排版的修改, 这两个功能应分离成两个不同的class. 上述代码中, 任何一个外部依赖的改变, 或金额计算逻辑的改变都需要修改代码.</li>
<li>Open–closed principle(开放封闭原则): 开放拓展, 封闭修改. 上述代码中, 金额计算可能属于被修改的代码, 因此应被包装成一盒不可修改的计算class, 所有新功能通过计算类的拓展实现.</li>
<li>Dependency Inversion Principle(依赖反转原则): 要求在代码中依赖抽象, 而不是具体实现. 上述代码中, Yahoo提供的汇率服务就是一个具体实现, 而不是一个抽象, Kafka也是相同道理.</li>
</ul>
<h2 id="7-What-is-DDD"><a href="#7-What-is-DDD" class="headerlink" title="7. What is DDD"></a>7. What is DDD</h2><p>DDD并不是一套框架, 而不是一种架构思想. 随着SOA(Service-oriented architecture)的崛起, microservice的概念开始冒头, DDD的思想可以为拆分服务提供了一套合理框架. DDD的思想让开发者去思考, 什么应被拆分为一个service, 如何降低业务逻辑与外部依赖的耦合. 这样才能减少维护成本, 提高开发效率.</p>

    </div>

    <footer class="post-footer">
      
      <div class="post-tags">
        
          <a href="/tags/Microservices/">Microservices</a>
        
      </div>
      

      
      
  <nav class="post-nav">
    
      <a class="prev" href="/p/aaa9.html">
        <i class="icon-left"></i>
        <span class="prev-text nav-default">DDD Overview</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/p/ab2f.html">
        <span class="next-text nav-default">Context Sensitive Analysis (1)</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="icon-right"></i>
      </a>
    
  </nav>

      
    </footer>
  </article>

  </div>
  
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    showProcessingMessages: true,
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: false,
        skipTags: ["script","noscript","style","textarea"]
    },
    TeX: {
        Macros:{
            Arr: ["\\{ #1 \\}", 1],
            fi: "{f\\,\\!_i}",
            SS: ["{#1\\:\\!_#2}",2],
            SUBx: ["{\\:\\!_#1}",1],
            EXPx: ["{\\;\\!^#1}",1],
            Ss: ["{#1\\,\\!_#2}",2],
            subx: ["{\\,\\!_#1}",1]
        }
    }
});
</script>


      </div>
    </div>

    
<script type="text/javascript">
  var disqus_shortname = 'zaf1ro';
  var disqus_identifier = 'p/a6fe.html';
  var disqus_title = "Why Use DDD";

  var disqus = {
    load : function disqus(){
        if(typeof DISQUS !== 'object') {
          (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
          }());
          $('#load-disqus').remove(); ///加载后移除按钮
        }
    }
  }

  
    var disqus_config = function () {
        this.page.url = disqus_url;
        this.page.identifier = disqus_identifier;
        this.page.title = disqus_title;
    };
  

</script>



    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.6.0.min.js"></script>
  

  

    
    <script type="text/javascript">
(function(){"use strict";var Theme={};Theme.backToTop={register:function(){var $backToTop=$('#back-to-top');$(window).scroll(function(){if($(window).scrollTop()>100){$backToTop.fadeIn(1000)}else{$backToTop.fadeOut(1000)}});$backToTop.click(function(){$('body').animate({scrollTop:0})})}};Theme.fancybox={register:function(){if($.fancybox){$('.post').each(function(){$(this).find('img').each(function(){$(this).wrap('<a class="fancybox" href="'+this.src+'" title="'+this.alt+'"></a>')})});$('.fancybox').fancybox({openEffect:'elastic',closeEffect:'elastic'})}}};this.Theme=Theme}.call(this));
</script>

<script type="text/javascript">
$(document).ready(function(){if(themeConfig.fancybox.enable){Theme.fancybox.register()}Theme.backToTop.register()});
</script>
    
<script type="text/javascript">
var themeConfig = {
  fancybox: {
    enable: false
  },
};
</script>

    <script>
    $('table').wrap('<div style="overflow-x: auto;"></div>');
</script>
    
    <script>
$(document).ready(function () {
    $('#sidebarCollapse').on('click', function(){
        $('#sidebar').toggleClass('active');
    });

    $('#toc ol li a').on('click', function(){
        $('#sidebar').toggleClass('active');
    });
});
</script>
  </body>
</html>
