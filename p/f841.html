<!DOCTYPE html>
<html lang="zh">
  <head>
    
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">



  <meta name="description" content="Pods"/>




  <meta name="keywords" content="K8s," />


<meta name="google-site-verification" content="qy4gf0StWj627u-7aIP3WDCLBi3jPYXhm57UC7TUcok" />
<meta name="baidu-site-verification" content="XJoPG7ad2Z" />

<link rel="alternate" hreflang="x-default" href="https://zaf1ro.github.io/p/f841.html" />
<link rel="alternate" hreflang="zh" href="https://zaf1ro.github.io/p/f841.html" />




  <link rel="alternate" href="/default" title="Zaf1ro" >




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.jpeg?v=1.1" />



<link rel="canonical" href="https://zaf1ro.github.io/p/f841.html"/>


<meta name="description" content="1. IntroductionPod作为k8s中的最小可部署单位, 其中可包含一个或多个container. 但一个pod中的container不可以处于不同nodes中. K8s中, Pod, Container和Node的区别如下:  Container: 表示一个独立的应用程序及其依赖 Pod: 作为k8s中的一个抽象概念, 表示项目中最小的逻辑单元, 其中可包含一个或多个container">
<meta property="og:type" content="article">
<meta property="og:title" content="Pods">
<meta property="og:url" content="https://zaf1ro.github.io/p/f841.html">
<meta property="og:site_name" content="Zaf1ro">
<meta property="og:description" content="1. IntroductionPod作为k8s中的最小可部署单位, 其中可包含一个或多个container. 但一个pod中的container不可以处于不同nodes中. K8s中, Pod, Container和Node的区别如下:  Container: 表示一个独立的应用程序及其依赖 Pod: 作为k8s中的一个抽象概念, 表示项目中最小的逻辑单元, 其中可包含一个或多个container">
<meta property="og:locale">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/pods-1-1.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/pods-1-2.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/pods-1-3.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/pods-1-4.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/pods-2-1.png">
<meta property="article:published_time" content="2019-10-10T16:19:20.000Z">
<meta property="article:modified_time" content="2025-01-09T05:18:30.555Z">
<meta property="article:tag" content="K8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zaf1ro.github.io/images/Kubernetes/pods-1-1.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />




    <title>
Pods - Zaf1ro
</title>
  <meta name="generator" content="Hexo 6.3.0"></head>

  <body>
  <nav id="sidebar" class="active on-post">
    <div id="third">
      <div id="sidebar-title">
        <h1 id="sidebar-title-text">
            <a href="/." class="logo">Home</a>
        </h1>
      </div>
      <div id="google-search">
  <script async src="https://cse.google.com/cse.js?cx=009060789867951546370:v3hkcobeuh9"></script>
  <div class="gcse-search"></div>
</div>
      
  <div id="toc">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Introduction"><span class="toc-text">1. Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Why-we-need-pods"><span class="toc-text">1.1 Why we need pods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-How-containers-share-the-same-IP-and-port"><span class="toc-text">1.2 How containers share the same IP and port</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Organize-containers-across-pods-properly"><span class="toc-text">1.3 Organize containers across pods properly</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Create-pod-from-YAML-or-JSON-descriptors"><span class="toc-text">2. Create pod from YAML or JSON descriptors</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-YAML-descriptor-of-an-existing-pod"><span class="toc-text">2.1 YAML descriptor of an existing pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Use-kubectl-create-to-create-the-pod"><span class="toc-text">2.2 Use kubectl create to create the pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-View-application-logs"><span class="toc-text">2.3 View application logs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Send-requests-to-the-pod"><span class="toc-text">2.4 Send requests to the pod</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Organize-pods-with-labels"><span class="toc-text">3. Organize pods with labels</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Introduction-of-labels"><span class="toc-text">3.1 Introduction of labels</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Modify-labels-of-existing-pods"><span class="toc-text">3.2 Modify labels of existing pods</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-List-subsets-of-pods-through-label-selectors"><span class="toc-text">4 List subsets of pods through label selectors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Use-labels-and-selectors-to-contrain-pod-scheduling"><span class="toc-text">5. Use labels and selectors to contrain pod scheduling</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Use-labels-for-categorizing-worker-nodes"><span class="toc-text">5.1 Use labels for categorizing worker nodes</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Annotate-pods"><span class="toc-text">6.Annotate pods</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Use-namespaces-to-group-resources"><span class="toc-text">7. Use namespaces to group resources</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-Introduction-of-namespace"><span class="toc-text">7.1 Introduction of namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-Manage-namespace"><span class="toc-text">7.2 Manage namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-Manage-resource-in-other-namespace"><span class="toc-text">7.3 Manage resource in other namespace</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Stop-and-remove-pods"><span class="toc-text">8. Stop and remove pods</span></a></li></ol>
  </div>

    </div>
  </nav>

    <div id="page">
      <header id="masthead"><div class="site-header-inner">
  
  <button class="nav-mobile-button on-post" id="sidebarCollapse">
  
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path d="M24 6h-24v-4h24v4zm0 4h-24v4h24v-4zm0 8h-24v4h24v-4z"/></svg>
  </button>
  
  


  <nav id="nav-top">
    
      
      <ul id="menu-top" class="nav-top-items on-post">
      
        
          <li class="menu-item">
            <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Zaf1ro">
              
              
                Github
              
            </a>
          </li>
        
      </ul>
    
  </nav>
</div>

      </header>
      <div id="content">
        
  <div class="primary">
    
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Pods
        
      </h1>
      <time class="post-time">
          10/10/19
      </time>
    </header>

    <div class="post-content">
      <h2 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h2><p>Pod作为k8s中的最小可部署单位, 其中可包含一个或多个container. 但一个pod中的container不可以处于不同nodes中.<br><img src="/images/Kubernetes/pods-1-1.png" alt="All containers of a pod run on the same node"></p>
<p>K8s中, Pod, Container和Node的区别如下:</p>
<ul>
<li>Container: 表示一个独立的应用程序及其依赖</li>
<li>Pod: 作为k8s中的一个抽象概念, 表示项目中最小的逻辑单元, 其中可包含一个或多个container, 且每个container拥有不同的功能, 并共同组成一个服务</li>
<li>Node: 表示一个物理机器或虚拟机</li>
</ul>
<h3 id="1-1-Why-we-need-pods"><a href="#1-1-Why-we-need-pods" class="headerlink" title="1.1 Why we need pods"></a>1.1 Why we need pods</h3><p>乍看之下container与pod存在功能重叠, 似乎并没有必要使用pod, 但pod为container做了一层必要的封装:</p>
<ul>
<li>container内的进程间通信需要开发者自行维护; pod内的container共享UTC namespace和network namespace, 可通过localhost connection与其他container直接通信</li>
<li>container内的进程崩溃时, 开发者需要某种机制检测崩溃并重启; k8s提供一整套pod重启机制(restart policy, liveness probe, backoff delay, backoff reset等)来重启pod中崩溃的container</li>
<li>container内进程的日志需开发者自行维护; k8s可查看pod内所有container的日志, 也可单独查看pod内某个container的日志</li>
<li>container内进程共享同一文件系统, 容易导致文件操作冲突; pod内的container拥有各自mount namespace, 因此container的文件系统相互隔离</li>
</ul>
<h3 id="1-2-How-containers-share-the-same-IP-and-port"><a href="#1-2-How-containers-share-the-same-IP-and-port" class="headerlink" title="1.2 How containers share the same IP and port"></a>1.2 How containers share the same IP and port</h3><p>一个pod内的所有container共享一个loopback network interface, 因此需避免多个container使用一个port; 不同pod内的container不存在该问题, 因为每个pod拥有各自的network namespace.<br>一个k8s cluster内的pod可通过以下方式相互通信:</p>
<ul>
<li>IP address: 每个pod拥有独立IP address, 可直接向pod对应的IP address发送信息. 即使pod位于不同node, pod的IP address也不会重复.<br><img src="/images/Kubernetes/pods-1-2.png" alt="Each pod gets a routable IP address and all other pods see the pod under that IP address"></li>
<li>Service: 表示一组拥有相同功能的pod集群, pod可直接向service发送信息, service会进行负载均衡, 并将消息发送给其中一个pod</li>
<li>DNS Resolution: k8s提供一个内置的DNS server, pod和service都可拥有自己的hostname, 让通信更轻松</li>
</ul>
<h3 id="1-3-Organize-containers-across-pods-properly"><a href="#1-3-Organize-containers-across-pods-properly" class="headerlink" title="1.3 Organize containers across pods properly"></a>1.3 Organize containers across pods properly</h3><p>K8s允许在单个pod中运行多个container, 但并不提倡这种做法: k8s无法水平拓展container, 同一pod中container的水平拓展会被绑定到一起. 假设pod中包含一个frontend container和一个backend container, 由于大部分情况下后端的压力更大, 需要比前端更多的container, 因此应将frontend container与backend container放置到不同的pod中.<br><img src="/images/Kubernetes/pods-1-3.png" alt="A container shouldn‘t run multiple processes / A pod shouldn‘t contain multiplecontainers"></p>
<p>通常一个pod中放置多个container是因为一个主体container需要一个或多个辅助container. 例如, web server需要一个downloader定期从外部下载所需资源, 或者log rotator, data processor, communication adapter.<br><img src="/images/Kubernetes/pods-1-4.png" alt="A main container and containers that support the main one"></p>
<p>以下是判断pod中是否放置多个container的标准:</p>
<ul>
<li>containers是否可以运行在不同的pod中?</li>
<li>containers是否呈现为单个组件</li>
<li>containers是否作为一个整体被scaling</li>
</ul>
<h2 id="2-Create-pod-from-YAML-or-JSON-descriptors"><a href="#2-Create-pod-from-YAML-or-JSON-descriptors" class="headerlink" title="2. Create pod from YAML or JSON descriptors"></a>2. Create pod from YAML or JSON descriptors</h2><h3 id="2-1-YAML-descriptor-of-an-existing-pod"><a href="#2-1-YAML-descriptor-of-an-existing-pod" class="headerlink" title="2.1 YAML descriptor of an existing pod"></a>2.1 YAML descriptor of an existing pod</h3><p>执行<code>kubectl run</code>可通过YAML或JSON文件创建一个全新的pod. 执行<code>kubectl get pod ... -o yaml</code>可获取该pod的YAML文件定义. </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">kubia-zxzij</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/created-by:</span> <span class="string">...</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="number">2016-03-18T12:37:50Z</span></span><br><span class="line">  <span class="attr">generateName:</span> <span class="string">kubia-</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">kubia</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubia-zxzij</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;294&quot;</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/default/pods/kubia-zxzij</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">3a564dc0-ed06-11e5-ba3b-42010af00004</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">luksa/kubia</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubia</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span> </span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/k8s.io/servacc</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">default-token-kvcqa</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">gke-kubia-e8fe08b8-node-txje</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-token-kvcqa</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">default-token-kvcqa</span> </span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://f0276994322d247ba...</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">luksa/kubia</span></span><br><span class="line">    <span class="attr">imageID:</span> <span class="string">docker://4c325bcc6b40c110226b89fe...</span></span><br><span class="line">    <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubia</span></span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">state:</span></span><br><span class="line">      <span class="attr">running:</span></span><br><span class="line">        <span class="attr">startedAt:</span> <span class="number">2016-03-18T12:46:05Z</span></span><br><span class="line">  <span class="attr">hostIP:</span> <span class="number">10.132</span><span class="number">.0</span><span class="number">.4</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Running</span></span><br><span class="line">  <span class="attr">podIP:</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.3</span></span><br><span class="line">  <span class="attr">startTime:</span> <span class="number">2016-03-18T12:44:32Z</span> </span><br></pre></td></tr></table></figure>
<p>Pod definition主要由三个部分组成:</p>
<ul>
<li>metadata: name, namespace, labels和pod的其他信息</li>
<li>spec: 对pod中内容的描述, 例如containers, environment variables, scheduler, volumes等信息</li>
<li>status: pod当前运行的信息, 例如container的状态, pod的IP等信息</li>
</ul>
<p>Pod definition中的<strong>port</strong>是纯粹的信息提醒, 并不具有强制力, 因此其他pod仍可向未定义的port发送信息, 该pod也可通过其他port与外部通信. </p>
<h3 id="2-2-Use-kubectl-create-to-create-the-pod"><a href="#2-2-Use-kubectl-create-to-create-the-pod" class="headerlink" title="2.2 Use kubectl create to create the pod"></a>2.2 Use kubectl create to create the pod</h3><p><code>kubectl create</code>可根据YAML文件创建pod, <code>kubectl get pod</code>会以YAML或JSON形式显示pod definition.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f kubia-manual.yaml</span><br><span class="line">pod <span class="string">&quot;kubia-manual&quot;</span> created</span><br><span class="line"></span><br><span class="line">$ kubectl get pod kubia-manual -o yaml</span><br><span class="line">$ kubectl get pod kubia-manual -o json</span><br></pre></td></tr></table></figure>

<p><code>kubectl get pods</code>可列出所有当前正在运行的pods.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME          READY STATUS  RESTARTS  AGE</span><br><span class="line">kubia-manual  1/1   Running 0         32s</span><br><span class="line">kubia-zxzij   1/1   Running 0         1d </span><br></pre></td></tr></table></figure>

<h3 id="2-3-View-application-logs"><a href="#2-3-View-application-logs" class="headerlink" title="2.3 View application logs"></a>2.3 View application logs</h3><p>通常放入container的程序应将日志直接输出到stdout或stderr, 而不是写入某个log文件中, 这样可以更加方便地浏览日志.</p>
<ul>
<li>container runtime(如Docker)会将stdout&#x2F;stderr直接存入文件中(如<code>/var/lib/docker/containers</code>), 执行<code>docker logs</code>可查看container日志.<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker logs &lt;container <span class="built_in">id</span>&gt;</span><br></pre></td></tr></table></figure></li>
<li>Kuberbetes可调用<code>kubectl logs</code>查看某个pod的log<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl logs kubia-manual</span><br></pre></td></tr></table></figure></li>
<li>若pod中包含多个containers, 可添加<code>-c &lt;container name&gt;</code>来输出指定container的log<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl logs kubia-manual -c kubia</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-4-Send-requests-to-the-pod"><a href="#2-4-Send-requests-to-the-pod" class="headerlink" title="2.4 Send requests to the pod"></a>2.4 Send requests to the pod</h3><p>Pod间的通信有多种方式实现, 最常用的方式是执行<code>kubectl expose</code>来创建一个service, 另一种方式是<strong>port forwarding</strong>. 执行<code>kubectl port-forward</code>可实现本机local port与pod的port的映射(例如: 将本机port 8888映射到pod的port 8080):</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl port-forward kubia-manual 8888:8080</span><br><span class="line">... Forwarding from 127.0.0.1:8888 -&gt; 8080</span><br><span class="line">... Forwarding from [::1]:8888 -&gt; 8080</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kubernetes/pods-2-1.png" alt="kubectl port-forward"></p>
<h2 id="3-Organize-pods-with-labels"><a href="#3-Organize-pods-with-labels" class="headerlink" title="3. Organize pods with labels"></a>3. Organize pods with labels</h2><p>通常情况下, pod的数量会随着工程规模增加而变多. 对于一个microservice architecture, microservice的种类很容易达到20个以上; 由于不同版本的microservice可能包含不同的pod, 单个pod也可能被水平拓展, 从而导致pod数量达到上百个, 因此如何管理pod成为一个问题: k8s使用<strong>labels</strong>统一管理pods.</p>
<h3 id="3-1-Introduction-of-labels"><a href="#3-1-Introduction-of-labels" class="headerlink" title="3.1 Introduction of labels"></a>3.1 Introduction of labels</h3><p>Label以<strong>key-value</strong>的形式挂在resource上. 需要使用部分resource时, 可使用<strong>label selectors</strong>来筛选resource. 每个resource可有一个或多个label, 且label可被修改, 添加和删除. 例如: 现在我们有一个pod defintiion名为<code>kubia-manual-with-labels.yaml</code>, 其拥有两个labels:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubia-manual-v2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">creation_method:</span> <span class="string">manual</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">luksa/kubia</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubia</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<p>执行<code>kubectl create -f kubia-manual-with-labels.yaml</code>创建pod, 执行<code>kubectl get pods --show-labels</code>显示pods上的所有labels</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods --show-labels</span><br><span class="line">NAME            READY STATUS  RESTARTS  AGE LABELS</span><br><span class="line">kubia-manual    1/1   Running 0         16m &lt;none&gt;</span><br><span class="line">kubia-manual-v2 1/1   Running 0         2m  creat_method=manual,<span class="built_in">env</span>=prod</span><br><span class="line">kubia-zxzij     1/1   Running 0         1d  run=kubia</span><br></pre></td></tr></table></figure>
<p>或添加<code>-L</code>指定一个或多个label:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -L creation_method,<span class="built_in">env</span></span><br><span class="line">NAME            READY STATUS  RESTARTS  AGE CREATION_METHOD ENV</span><br><span class="line">kubia-manual    1/1   Running 0         16m &lt;none&gt;          &lt;none&gt;</span><br><span class="line">kubia-manual-v2 1/1   Running 0         2m  manual          prod</span><br><span class="line">kubia-zxzij     1/1   Running 0         1d  &lt;none&gt;          &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Modify-labels-of-existing-pods"><a href="#3-2-Modify-labels-of-existing-pods" class="headerlink" title="3.2 Modify labels of existing pods"></a>3.2 Modify labels of existing pods</h3><p>k8s允许用户随时添加或修改pod的label.</p>
<ol>
<li>Add a label to pod  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl label pods kubia-manual creation_method=manual</span><br><span class="line">pod <span class="string">&quot;kubia-manual&quot;</span> labeled</span><br></pre></td></tr></table></figure></li>
<li>Change the existing labels, using &quot;--overwrite&quot; option  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl label pods kubia-manual-v2 <span class="built_in">env</span>=debug --overwrite</span><br><span class="line">pod <span class="string">&quot;kubia-manual-v2&quot;</span> labeled</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="4-List-subsets-of-pods-through-label-selectors"><a href="#4-List-subsets-of-pods-through-label-selectors" class="headerlink" title="4 List subsets of pods through label selectors"></a>4 List subsets of pods through label selectors</h2><p><strong>Label selector</strong>可通过以下方式筛选resource:</p>
<ul>
<li>label的key为指定值</li>
<li>label的key为指定值, 且label的value为指定值</li>
<li>label的key为指定值, 且label的value不为指定值</li>
</ul>
<p>以下是label selector使用的方法:</p>
<ol>
<li>List all pods with specified key and value  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -l creation_method=manual</span><br><span class="line">NAME            READY STATUS  RESTARTS AGE</span><br><span class="line">kubia-manual    1/1   Running 0        51m</span><br><span class="line">kubia-manual-v2 1/1   Running 0        37m</span><br></pre></td></tr></table></figure></li>
<li>List all pods with specified key  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -l <span class="built_in">env</span></span><br><span class="line">NAME            READY STATUS  RESTARTS AGE</span><br><span class="line">kubia-manual-v2 1/1   Running 0        37m</span><br></pre></td></tr></table></figure></li>
<li>List all pods without specified key  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -l <span class="string">&#x27;!env&#x27;</span></span><br><span class="line">NAME         READY STATUS  RESTARTS AGE</span><br><span class="line">kubia-manual 1/1   Running 0        51m</span><br><span class="line">kubia-zxzij  1/1   Running 0        10d</span><br></pre></td></tr></table></figure></li>
</ol>
<p>除上述方式外, label selector还支持一下方式筛选pod:</p>
<ul>
<li><code>creation_method!=manual</code>: 筛选所有<code>creation_method</code>不为<code>manual</code>的pod</li>
<li><code>env in (prod,devel)</code>: 筛选所有<code>env</code>为<code>prod</code>或<code>devel</code>的pod</li>
<li><code>env notin (prod,devel)</code>: 筛选所有<code>env</code>不为<code>prod</code>且不为<code>devel</code>的pod</li>
<li>上述方式可用<strong>comma</strong>(逗号)组合, 例如: <code>app=pc, rel=beta</code></li>
</ul>
<h2 id="5-Use-labels-and-selectors-to-contrain-pod-scheduling"><a href="#5-Use-labels-and-selectors-to-contrain-pod-scheduling" class="headerlink" title="5. Use labels and selectors to contrain pod scheduling"></a>5. Use labels and selectors to contrain pod scheduling</h2><p>当pod被创建后, k8s会将其随机分配到cluster中的一个node. 但由于node并不是相同配置. 大部分情况下我们不需要对pod的分配做任何干预, 因为每个pod会获得所需的计算资源(CPU, 内存, 存储空间等); 但某些情况下可能需要手动分配pod, 尤其当node的硬件配置不一致时: 例如, 一个k8s cluster中一些node使用HDD, 另一些node使用SSD, 我们希望保证磁盘访问频繁的pod(如数据库应用)分配到使用SSD的node.<br>除了pod, k8s允许向node添加label, 并在pod definition中指定node的label.</p>
<h3 id="5-1-Use-labels-for-categorizing-worker-nodes"><a href="#5-1-Use-labels-for-categorizing-worker-nodes" class="headerlink" title="5.1 Use labels for categorizing worker nodes"></a>5.1 Use labels for categorizing worker nodes</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl label node gke-kubia-85f6-node-0rrx gpu=<span class="literal">true</span></span><br><span class="line">node <span class="string">&quot;gke-kubia-85f6-node-0rrx&quot;</span> labeled</span><br></pre></td></tr></table></figure>
<p>然后在pod definition的YAML文件中添加node selector:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubia-gpu</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">  <span class="attr">gpu:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">luksa/kubia</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubia</span></span><br></pre></td></tr></table></figure>
<p>运行该YAML文件时, pod会自动分配到拥有GPU的node上运行. 当然, 也可以将pod直接分配到某个node, 因为每个node都有一个唯一的label. 该label的key为<strong>kubernetes.io&#x2F;hostname</strong>, label的value为<strong>kunode的hostname</strong>. 若在<code>nodeSelector</code>中使用该label, 则pod会与该node绑定; 若该node不可用, 则无法生成pod.</p>
<h2 id="6-Annotate-pods"><a href="#6-Annotate-pods" class="headerlink" title="6.Annotate pods"></a>6.Annotate pods</h2><p>除了labels, pods和其他k8s资源还拥有annotations. Annotations也以<strong>key-value</strong>形式存在, 但它并不负责管理resource, 而是用于说明resource, 例如: 创建该resource的用户姓名.</p>
<ol>
<li>Look up an object&#39;s annotations: Annotation无法单独获取, pod definition或<strong>kubectl describe</strong>包含annotation.</li>
<li>Add and modify annotations: <strong>kubectl annotate</strong>可为对应resource添加annotation; 或key相同, 则覆盖value.  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl annotate pod kubia-manual mycompany.com/someannotation=<span class="string">&quot;foo bar&quot;</span></span><br><span class="line">pod <span class="string">&quot;kubia-manual&quot;</span> annotated</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="7-Use-namespaces-to-group-resources"><a href="#7-Use-namespaces-to-group-resources" class="headerlink" title="7. Use namespaces to group resources"></a>7. Use namespaces to group resources</h2><p>Label作为一种管理k8s资源的方法十分有效, 但存在以下问题:</p>
<ul>
<li>查看资源时, 每次都需在命令后添加对应的label, 否则会看到所有资源</li>
<li>由于一个资源可以拥有多个label, 因此资源间会出现大量重叠label</li>
</ul>
<p>总结来说, label只做到<strong>资源分组</strong>, 并不实现<strong>资源隔离</strong>, 因此k8s提供了<strong>namespace</strong>来隔离资源.</p>
<h3 id="7-1-Introduction-of-namespace"><a href="#7-1-Introduction-of-namespace" class="headerlink" title="7.1 Introduction of namespace"></a>7.1 Introduction of namespace</h3><p>Namespace可将资源隔离为不同group, 通常会按照开发环境来划分namespace(dev, stage, prod). 需要注意的是, 并不是所有资源都有namespace, 例如node, 这类资源称为<strong>cluster-level resource</strong>, 因此不能存在同名资源.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get ns</span><br><span class="line">NAME        LABELS STATUS AGE</span><br><span class="line">default     &lt;none&gt; Active 1h</span><br><span class="line">kube-public &lt;none&gt; Active 1h</span><br><span class="line">kube-system &lt;none&gt; Active 1h</span><br></pre></td></tr></table></figure>
<p>若不指定namespace, 则kubectl默认在<strong>default</strong>的namespace下操作. 除了default之外, k8s会创建其他namespace. 若需要使用其他namespace下的resource, 可使用<code>--namespace</code>指定某个namespace</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods --namespace kube-system</span><br><span class="line">NAME                               READY STATUS  RESTARTS AGE</span><br><span class="line">fluentd-cloud-kubia-e8fe-node-txje 1/1   Running 0        1h</span><br><span class="line">heapster-v11-fz1ge                 1/1   Running 0        1h</span><br><span class="line">kube-dns-v9-p8a4t                  0/4   Pending 0        1h</span><br><span class="line">kube-ui-v4-kdlai                   1/1   Running 0        1h</span><br><span class="line">l7-lb-controller-v0.5.2-bue96      2/2   Running 92       1h</span><br></pre></td></tr></table></figure>
<p>需要注意的是, namespace提供的<strong>隔离性</strong>只面向user, 并不面向任何object. 例如, 现在k8s cluster中有两个namespace, 分别名为<code>foo</code>和<code>bar</code>, 用户在foo中查询的任何资源都只属于foo; 但若foo中的某个pod知道bar中某个pod的地址, 其仍可以向另一个namespace中的object发送信息.</p>
<h3 id="7-2-Manage-namespace"><a href="#7-2-Manage-namespace" class="headerlink" title="7.2 Manage namespace"></a>7.2 Manage namespace</h3><p>Namespace与其他资源一样, 都可通过<code>kubectl</code>命令或YAML文件创建.</p>
<ol>
<li>使用YAML或JSON文件  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">custom-namespace</span></span><br></pre></td></tr></table></figure>
  使用kubectl将YAML文件发送给K8s API server:  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f custom-namespace.yaml</span><br><span class="line">namespace <span class="string">&quot;custom-namespace&quot;</span> created</span><br></pre></td></tr></table></figure></li>
<li>使用<code>kubectl create namespace</code>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f kubia-manual.yaml -n custom-namespace</span><br><span class="line">pod <span class="string">&quot;kubia-manual&quot;</span> created</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="7-3-Manage-resource-in-other-namespace"><a href="#7-3-Manage-resource-in-other-namespace" class="headerlink" title="7.3 Manage resource in other namespace"></a>7.3 Manage resource in other namespace</h3><p>若需要在其他namespace中创建资源, 可通过--namespace(或-n)或在metadata.namespace中指定namespace.</p>
<ol>
<li>执行kubectl命令时指定namespace  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f kubia-manual.yaml -n custom-namespace</span><br><span class="line">pod <span class="string">&quot;kubia-manual&quot;</span> created</span><br></pre></td></tr></table></figure></li>
<li>在YAML文件中指定namespace  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="8-Stop-and-remove-pods"><a href="#8-Stop-and-remove-pods" class="headerlink" title="8. Stop and remove pods"></a>8. Stop and remove pods</h2><ol>
<li>Delete a pod by name  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl delete pod kubia-gpu</span><br><span class="line">pod <span class="string">&quot;kubia-gpu&quot;</span> deleted</span><br></pre></td></tr></table></figure>
  k8s会终止名为<code>kubia-gpudepod</code>中所有的container: k8s向container中的所有进程发送<strong>SIGTERM</strong>并等待一定时间(默认为30秒), 若进程没有在指定时间内关闭, 则向其发送<strong>SIGKILL</strong>以实行强制关闭.</li>
<li>Delete pods using label selectors<br>  若需要删除多个pod, 可使用label selector筛选.  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl delete pods -l creation_method=manual</span><br><span class="line">pod <span class="string">&quot;kubia-manual&quot;</span> deleted</span><br><span class="line">pod <span class="string">&quot;kubia-manual-v2&quot;</span> deleted </span><br></pre></td></tr></table></figure></li>
<li>Delete pods by deleting the whole namespace<br>  若需要删除某个namespace中的所有pod, 可直接删除该namespace, k8s会自动删除该namespace中所有pod.  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl delete ns custom-namespace</span><br><span class="line">namespace <span class="string">&quot;custom-namespace&quot;</span> deleted</span><br></pre></td></tr></table></figure></li>
<li>Delete all pods in a namespace, while keep the namespace<br>  若只想删除某个namespace, 不想删除namespace, 可使用<code>--all</code>.  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl delete pods --all</span><br><span class="line">pod <span class="string">&quot;kubia-zxzij&quot;</span> deleted</span><br></pre></td></tr></table></figure></li>
<li>Delete all resources in a namespace<br>  若需要删除namespace中所有资源, 可执行以下命令.  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl delete all --all</span><br><span class="line">pod <span class="string">&quot;kubia-09as0&quot;</span> deleted</span><br><span class="line">replicationcontroller <span class="string">&quot;kubia&quot;</span> deleted</span><br><span class="line">service <span class="string">&quot;kubernetes&quot;</span> deleted</span><br><span class="line">service <span class="string">&quot;kubia-http&quot;</span> deleted</span><br></pre></td></tr></table></figure>
  <code>all</code>表示所有类型的资源, <code>--all</code>表示某个类型下的所有resource</li>
</ol>

    </div>

    <footer class="post-footer">
      
      <div class="post-tags">
        
          <a href="/tags/K8s/">K8s</a>
        
      </div>
      

      
      
  <nav class="post-nav">
    
      <a class="prev" href="/p/17e0.html">
        <i class="icon-left"></i>
        <span class="prev-text nav-default">Replication Controllers</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/p/4cb2.html">
        <span class="next-text nav-default">Interprocess Communication</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="icon-right"></i>
      </a>
    
  </nav>

      
    </footer>
  </article>

  </div>
  
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    showProcessingMessages: true,
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: false,
        skipTags: ["script","noscript","style","textarea"]
    },
    TeX: {
        Macros:{
            Arr: ["\\{ #1 \\}", 1],
            fi: "{f\\,\\!_i}",
            SS: ["{#1\\:\\!_#2}",2],
            SUBx: ["{\\:\\!_#1}",1],
            EXPx: ["{\\;\\!^#1}",1],
            Ss: ["{#1\\,\\!_#2}",2],
            subx: ["{\\,\\!_#1}",1]
        }
    }
});
</script>


      </div>
    </div>

    
<script type="text/javascript">
  var disqus_shortname = 'zaf1ro';
  var disqus_identifier = 'p/f841.html';
  var disqus_title = "Pods";

  var disqus = {
    load : function disqus(){
        if(typeof DISQUS !== 'object') {
          (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
          }());
          $('#load-disqus').remove(); ///加载后移除按钮
        }
    }
  }

  
    var disqus_config = function () {
        this.page.url = disqus_url;
        this.page.identifier = disqus_identifier;
        this.page.title = disqus_title;
    };
  

</script>



    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.6.0.min.js"></script>
  

  

    
    <script type="text/javascript">
(function(){"use strict";var Theme={};Theme.backToTop={register:function(){var $backToTop=$('#back-to-top');$(window).scroll(function(){if($(window).scrollTop()>100){$backToTop.fadeIn(1000)}else{$backToTop.fadeOut(1000)}});$backToTop.click(function(){$('body').animate({scrollTop:0})})}};Theme.fancybox={register:function(){if($.fancybox){$('.post').each(function(){$(this).find('img').each(function(){$(this).wrap('<a class="fancybox" href="'+this.src+'" title="'+this.alt+'"></a>')})});$('.fancybox').fancybox({openEffect:'elastic',closeEffect:'elastic'})}}};this.Theme=Theme}.call(this));
</script>

<script type="text/javascript">
$(document).ready(function(){if(themeConfig.fancybox.enable){Theme.fancybox.register()}Theme.backToTop.register()});
</script>
    
<script type="text/javascript">
var themeConfig = {
  fancybox: {
    enable: false
  },
};
</script>

    <script>
    $('table').wrap('<div style="overflow-x: auto;"></div>');
</script>
    
    <script>
$(document).ready(function () {
    $('#sidebarCollapse').on('click', function(){
        $('#sidebar').toggleClass('active');
    });

    $('#toc ol li a').on('click', function(){
        $('#sidebar').toggleClass('active');
    });
});
</script>
  </body>
</html>
