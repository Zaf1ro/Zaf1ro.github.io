<!DOCTYPE html>
<html lang="zh">
  <head>
    
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">



  <meta name="description" content="ConfigMap and Secret"/>




  <meta name="keywords" content="K8s," />


<meta name="google-site-verification" content="qy4gf0StWj627u-7aIP3WDCLBi3jPYXhm57UC7TUcok" />
<meta name="baidu-site-verification" content="XJoPG7ad2Z" />

<link rel="alternate" hreflang="x-default" href="https://zaf1ro.github.io/p/95.html" />
<link rel="alternate" hreflang="zh" href="https://zaf1ro.github.io/p/95.html" />




  <link rel="alternate" href="/default" title="Zaf1ro" >




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.jpeg?v=1.1" />



<link rel="canonical" href="https://zaf1ro.github.io/p/95.html"/>


<meta name="description" content="1. IntroductionContainer技术(例如Docker)提供了三种简易方式来为运行在container中的应用提供configuration:  为container传递command-line arguments 为container设置不同的environment variables 将configuration file以Volume的形式挂在container上  Kube">
<meta property="og:type" content="article">
<meta property="og:title" content="ConfigMap and Secret">
<meta property="og:url" content="https://zaf1ro.github.io/p/95.html">
<meta property="og:site_name" content="Zaf1ro">
<meta property="og:description" content="1. IntroductionContainer技术(例如Docker)提供了三种简易方式来为运行在container中的应用提供configuration:  为container传递command-line arguments 为container设置不同的environment variables 将configuration file以Volume的形式挂在container上  Kube">
<meta property="og:locale">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/config-1.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/config-2.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/config-3.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/config-4.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/config-5.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/config-6.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/config-7.png">
<meta property="og:image" content="https://zaf1ro.github.io/images/Kubernetes/config-8.png">
<meta property="article:published_time" content="2019-10-31T12:19:52.000Z">
<meta property="article:modified_time" content="2024-08-20T16:43:04.029Z">
<meta property="article:tag" content="K8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zaf1ro.github.io/images/Kubernetes/config-1.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />




    <title>
ConfigMap and Secret - Zaf1ro
</title>
  <meta name="generator" content="Hexo 6.3.0"></head>

  <body>
  <nav id="sidebar" class="active on-post">
    <div id="third">
      <div id="sidebar-title">
        <h1 id="sidebar-title-text">
            <a href="/." class="logo">Home</a>
        </h1>
      </div>
      <div id="google-search">
  <script async src="https://cse.google.com/cse.js?cx=009060789867951546370:v3hkcobeuh9"></script>
  <div class="gcse-search"></div>
</div>
      
  <div id="toc">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Introduction"><span class="toc-text">1. Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Pass-Command-line-Arguments-to-Containers"><span class="toc-text">2. Pass Command-line Arguments to Containers</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Define-the-Command-and-Arguments-in-Docker"><span class="toc-text">2.1 Define the Command and Arguments in Docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Override-the-Command-and-Arguments-in-Kubernetes"><span class="toc-text">2.2 Override the Command and Arguments in Kubernetes</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Set-Environment-Variables-for-a-Container"><span class="toc-text">3. Set Environment Variables for a Container</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-ConfigMap"><span class="toc-text">4. ConfigMap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Create-a-ConfigMap"><span class="toc-text">4.1 Create a ConfigMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Pass-a-ConfigMap-Entry-to-a-Container-as-an-Environment-Variable"><span class="toc-text">4.2 Pass a ConfigMap Entry to a Container as an Environment Variable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-Pass-all-Entries-of-a-ConfigMap-as-Environment-Variable"><span class="toc-text">4.3 Pass all Entries of a ConfigMap as Environment Variable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-Pass-a-ConfigMap-Entry-as-a-Command-line-Argument"><span class="toc-text">4.4 Pass a ConfigMap Entry as a Command-line Argument</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-Use-a-ConfigMap-Volume-to-Expose-ConfigMap-Entries-as-Files"><span class="toc-text">4.5 Use a ConfigMap Volume to Expose ConfigMap Entries as Files</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-Update-Config-without-Restarting-the-App"><span class="toc-text">4.6 Update Config without Restarting the App</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Screts"><span class="toc-text">5. Screts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-default-token-Secret"><span class="toc-text">5.1 default token Secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-Create-a-Secret"><span class="toc-text">5.2 Create a Secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Compare-ConfigMap-and-Secret"><span class="toc-text">5.3 Compare ConfigMap and Secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-Use-the-Secret-in-a-Pod"><span class="toc-text">5.4 Use the Secret in a Pod</span></a></li></ol></li></ol>
  </div>

    </div>
  </nav>

    <div id="page">
      <header id="masthead"><div class="site-header-inner">
  
  <button class="nav-mobile-button on-post" id="sidebarCollapse">
  
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path d="M24 6h-24v-4h24v4zm0 4h-24v4h24v-4zm0 8h-24v4h24v-4z"/></svg>
  </button>
  
  


  <nav id="nav-top">
    
      
      <ul id="menu-top" class="nav-top-items on-post">
      
        
          <li class="menu-item">
            <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Zaf1ro">
              
              
                Github
              
            </a>
          </li>
        
      </ul>
    
  </nav>
</div>

      </header>
      <div id="content">
        
  <div class="primary">
    
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          ConfigMap and Secret
        
      </h1>
      <time class="post-time">
          10/31/19
      </time>
    </header>

    <div class="post-content">
      <h2 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h2><p>Container技术(例如Docker)提供了三种简易方式来为运行在container中的应用提供configuration:</p>
<ol>
<li>为container传递command-line arguments</li>
<li>为container设置不同的environment variables</li>
<li>将configuration file以Volume的形式挂在container上</li>
</ol>
<p>Kubernetes也提供了两种Resources为container提供configuration:</p>
<ol>
<li>ConfigMap: 用于存储配置信息</li>
<li>Secret: 用于存储敏感信息</li>
</ol>
<h2 id="2-Pass-Command-line-Arguments-to-Containers"><a href="#2-Pass-Command-line-Arguments-to-Containers" class="headerlink" title="2. Pass Command-line Arguments to Containers"></a>2. Pass Command-line Arguments to Containers</h2><p>Kubernetes允许传递给Pod中的container一些command-line arguments.</p>
<h3 id="2-1-Define-the-Command-and-Arguments-in-Docker"><a href="#2-1-Define-the-Command-and-Arguments-in-Docker" class="headerlink" title="2.1 Define the Command and Arguments in Docker"></a>2.1 Define the Command and Arguments in Docker</h3><p>Dockerfile提供了两个instructions:</p>
<ol>
<li>ENTRYPOINT: 当container启动时运行的command</li>
<li>CMD: 主要为ENTRYPOINT提供参数, 也可执行command</li>
</ol>
<p>当运行**docker run &lt;image&gt;<strong>时会自动调用ENTRYPOINT和CMD, 也可以使用</strong>docker run &lt;image&gt; &lt;arguments&gt;**来覆盖CMD中的参数.</p>
<ul>
<li>ENTRYPOINT存在两种形式: <ol>
<li>exec: [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</li>
<li>shell: command param1 param2</li>
</ol>
</li>
<li>CMD存在三种形式:<ol>
<li>exec: [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</li>
<li>shell: command param1 param2</li>
<li>parameters to ENTRYPOINT: [&quot;param1&quot;, &quot;param2&quot;]</li>
</ol>
</li>
</ul>
<p>exec形式会直接开启一个进程来执行command, shell形式会先开启一个shell进程, 再在shell进程中执行command. 一般情况下使用exec形式即可.</p>
<h3 id="2-2-Override-the-Command-and-Arguments-in-Kubernetes"><a href="#2-2-Override-the-Command-and-Arguments-in-Kubernetes" class="headerlink" title="2.2 Override the Command and Arguments in Kubernetes"></a>2.2 Override the Command and Arguments in Kubernetes</h3><p>Kubernetes提供了command和args来覆盖image中的ENTRYPOINT和CMD:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">some/image</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/command&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;arg1&quot;</span>, <span class="string">&quot;arg2&quot;</span>, <span class="string">&quot;arg3&quot;</span>]</span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>所以一般不用定义ENTRYPOINT和CMD, 直接在Pod中定义即可. 注意: args中的数字必须用double quote(双引号)包裹, 字符串则不必.</p>
<h2 id="3-Set-Environment-Variables-for-a-Container"><a href="#3-Set-Environment-Variables-for-a-Container" class="headerlink" title="3. Set Environment Variables for a Container"></a>3. Set Environment Variables for a Container</h2><p>Kubernetes允许为Pod中的每个container定制不同的environment variables, 如下图:<br><img src="/images/Kubernetes/config-1.png" alt="Environment variables can be set per container"></p>
<p>Environment variables之所以能作为配置参数, 因为所有脚本和语言都可以获取系统的environment variables; 但与command-line argument相同, 一旦container被启动, 则很难修改.</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">luksa/fortune:env</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INTERVAL</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;30&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">html-generator</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>Kubernetes还支持在YAML中使用之前设置的environment variables: 使用**$(VAR)**语法即可调用之前定义的environment variables:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FIRST_VAR</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;foo&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SECOND_VAR</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;$(FIRST_VAR)bar&quot;</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>上述例子中, FIRST_VAR为foo, SECOND_VAR为foobar. 由于environment variable无法随时修改, 所以不同需求的Pod需要多个的YAML文件来标注不同的environment variables.</p>
<h2 id="4-ConfigMap"><a href="#4-ConfigMap" class="headerlink" title="4. ConfigMap"></a>4. ConfigMap</h2><p>ConfigMap作为Kubernetes的resource之一, 可将configuration中的内容与Pod定义分离, 以key&#x2F;value的map形式作为configuration的格式. Container并不会直接读取ConfigMap中的配置信息, 而是通过environment variables或volume形式来读取配置信息, 如下图:<br><img src="/images/Kubernetes/config-2.png" alt="Pods use ConfigMaps through environment variables and configMap volumes"></p>
<p>ConfigMap不与某个Pod绑定, 只与namespace绑定, 所以同一namespace下的Pod共享ConfigMap.</p>
<h3 id="4-1-Create-a-ConfigMap"><a href="#4-1-Create-a-ConfigMap" class="headerlink" title="4.1 Create a ConfigMap"></a>4.1 Create a ConfigMap</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl create configmap fortune-config --from-literal=sleep-interval=25</span><br><span class="line">configmap <span class="string">&quot;fortune-config&quot;</span> created</span><br></pre></td></tr></table></figure>
<p>通过<strong>kubectl create configmap</strong> command可直接创建ConfigMap, 上述指令创造了一个名为fortune-config的ConfigMap, 包含一个entry, 其中key为sleep-interval, value为25. 也可在ConfigMap中创建多个entries:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl create configmap myconfigmap --from-literal=foo=bar \</span><br><span class="line">--from-literal=bar=baz --from-literal=one=two</span><br></pre></td></tr></table></figure>

<p>调用<strong>kubectl get configmap</strong> command可查看当前ConfigMap</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl get configmap fortune-config -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  sleep-interval: <span class="string">&quot;25&quot;</span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: 2016-08-11T20:31:08Z</span><br><span class="line">  name: fortune-config</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">&quot;910025&quot;</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/configmaps/fortune-config</span><br><span class="line">  uid: 88c4167e-6002-11e6-a50d-42010af00237</span><br></pre></td></tr></table></figure>

<p><strong>--from-literal</strong>表示直接写入Entry的key和value. 还可使用**--from-file**从文件中导入entry, 例如:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl create configmap my-config --from-file=config-file.conf</span><br></pre></td></tr></table></figure>
<p>上述新建的ConfigMap名为<strong>my-config</strong>, 包含一条entry, 其中key为<strong>config-file.conf</strong>(也就是文件名), value为config-file.conf文件里的内容. 还可从directory中将所有文件加入到ConfigMap中:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl create configmap my-config --from-file=/path/to/dir</span><br></pre></td></tr></table></figure>
<p>所有目录下的文件都会加入到ConfigMap中, 其中key为文件名, value为文件内容. ConfigMap也支持这几种方式的混合使用, 如下:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl create configmap my-config \</span><br><span class="line">--from-file=foo.json --from-file=bar=foobar.conf \</span><br><span class="line">--from-file=config-opts/ --from-literal=some=thing</span><br></pre></td></tr></table></figure>
<p>结果如下图:<br><img src="/images/Kubernetes/config-3.png" alt="Create a ConfigMap from individual files, a directory, and a literal value"></p>
<h3 id="4-2-Pass-a-ConfigMap-Entry-to-a-Container-as-an-Environment-Variable"><a href="#4-2-Pass-a-ConfigMap-Entry-to-a-Container-as-an-Environment-Variable" class="headerlink" title="4.2 Pass a ConfigMap Entry to a Container as an Environment Variable"></a>4.2 Pass a ConfigMap Entry to a Container as an Environment Variable</h3><p>在Pod中将ConfigMap中的entry传给container的environment variable是container读取ConfigMap的最简单方式:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fortune-env-from-configmap</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">luksa/fortune:env</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INTERVAL</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">fortune-config</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">sleep-interval</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>上述例子中, container中设置environment variable的key为<strong>INTERVAL</strong>, value从名为<strong>fortune-config</strong>的ConfigMap中获取key为<strong>sleep-interval</strong>的value值. 若YAML文件中标注的ConfigMap不存在, 则该container不会被启动, 但Pod中的其他container照常运行; 当缺失的ConfigMap被创建后, container也会自动启动. 若在YAML中设置<strong>configMapKeyRef.optional: true</strong>, 即使ConfigMap不存在, container依然会启动.</p>
<h3 id="4-3-Pass-all-Entries-of-a-ConfigMap-as-Environment-Variable"><a href="#4-3-Pass-all-Entries-of-a-ConfigMap-as-Environment-Variable" class="headerlink" title="4.3 Pass all Entries of a ConfigMap as Environment Variable"></a>4.3 Pass all Entries of a ConfigMap as Environment Variable</h3><p>Kubernetes 1.6提供了一种可以将ConfigMap中所有entries导入到Container的environment variable的方法:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">some-image</span></span><br><span class="line">    <span class="attr">envFrom:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">prefix:</span> <span class="string">CONFIG_</span></span><br><span class="line">      <span class="attr">configMapRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">my-config-map</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>注意, environment variable不支持一些特殊符号. 若ConfigMap中entry的key或value含有不合规的符号(例如: foo-bar), 则该entry不被导入environment variable.</p>
<h3 id="4-4-Pass-a-ConfigMap-Entry-as-a-Command-line-Argument"><a href="#4-4-Pass-a-ConfigMap-Entry-as-a-Command-line-Argument" class="headerlink" title="4.4 Pass a ConfigMap Entry as a Command-line Argument"></a>4.4 Pass a ConfigMap Entry as a Command-line Argument</h3><p>ConfigMap中的entry也可作为参数传入container:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fortune-args-from-configmap</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">luksa/fortune:args</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INTERVAL</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">fortune-config</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">sleep-interval</span></span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;$(INTERVAL)&quot;</span>]</span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>结果如下图:<br><img src="/images/Kubernetes/config-4.png" alt="Pass a ConfigMap entry as a command-line argument"></p>
<h3 id="4-5-Use-a-ConfigMap-Volume-to-Expose-ConfigMap-Entries-as-Files"><a href="#4-5-Use-a-ConfigMap-Volume-to-Expose-ConfigMap-Entries-as-Files" class="headerlink" title="4.5 Use a ConfigMap Volume to Expose ConfigMap Entries as Files"></a>4.5 Use a ConfigMap Volume to Expose ConfigMap Entries as Files</h3><p>将ConfigMap挂载为volume只需要将volume的类型设置为configMap即可. 假设现在给Nginx添加配置文件<strong>my-nginx-config.conf</strong>, 文件内容如下:</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen      80;</span><br><span class="line">  server_name www.kubia-example.com;</span><br><span class="line">  gzip        on;</span><br><span class="line">  gzip_types text/plain application/xml;</span><br><span class="line">  location &#123;</span><br><span class="line">    root  /usr/share/nginx/html;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将该文件和名为<strong>sleep-interval</strong>的文件放入同一文件夹中, 如下图:<br><img src="/images/Kubernetes/config-5.png" alt="The contents of the configmap-files directory and its files"></p>
<p>调用<strong>kubectl create configmmap</strong>创建新的ConfigMap:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl create configmap fortune-config --from-file=configmap-files</span><br><span class="line">configmap <span class="string">&quot;fortune-config&quot;</span> created</span><br></pre></td></tr></table></figure>

<p>Nginx从**&#x2F;etc&#x2F;nginx&#x2F;nginx.conf**路径中读取文件并添加到配置, 因此需要将ConfigMap挂在该路径上:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fortune-configmap-volume</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-server</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/nginx/conf.d</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">fortune-config</span></span><br><span class="line"> <span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>结果如下:<br><img src="/images/Kubernetes/config-6.png" alt="Pass ConfigMap entries to a pod as files in a volume"></p>
<p>也可以指定ConfigMap中的某一个或几个entry挂在volume上:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">configMap:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">fortune-config</span></span><br><span class="line">    <span class="attr">items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">my-nginx-config.conf</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">gzip.conf</span> </span><br></pre></td></tr></table></figure>
<p>需要注意的是, 上述使用ConfigMap作为volume会覆盖挂载路径中的所有文件. 若**&#x2F;etc&#x2F;nginx&#x2F;conf.d<strong>中原本有其他文件, 则会因为fortune-config的挂载而消失. 为了保证不覆盖原本路径中的文件, 需在YAML中添加</strong>subPath**属性:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">some/image</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myvolume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/someconfig.conf</span></span><br><span class="line">      <span class="attr">subPath:</span> <span class="string">myconfig.conf</span> </span><br></pre></td></tr></table></figure>
<p>这样就可以保证ConfigMap Volume只有myconfig.conf被挂载到container的&#x2F;etc&#x2F;someconfig.conf路径中, 如下图:<br><img src="/images/Kubernetes/config-7.png" alt="Mount a single file from a volume"></p>
<p>也可以在YAML中设置ConfigMap Volume中文件的权限:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">configMap:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">fortune-config</span></span><br><span class="line">    <span class="attr">defaultMode:</span> <span class="string">&quot;6600&quot;</span> </span><br></pre></td></tr></table></figure>

<h3 id="4-6-Update-Config-without-Restarting-the-App"><a href="#4-6-Update-Config-without-Restarting-the-App" class="headerlink" title="4.6 Update Config without Restarting the App"></a>4.6 Update Config without Restarting the App</h3><p>Environment variable和command-line argument的缺陷在于无法及时更新, 一旦Pod运行则无法修改. ConfigMap Volume则可无需container重启的同时更新配置信息. 调用<strong>kubectl edit</strong>可修改ConfigMap:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl edit configmap fortune-config</span><br></pre></td></tr></table></figure>
<p>由于Nginx不会主动查看配置文件是否更新, 所以需要向Nginx发送信号来重新加载:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> fortune-configmap-volume -c web-server -- nginx -s reload</span><br></pre></td></tr></table></figure>
<p>ConfigMap的修改和读取都是原子性的, 所以不必担心container会读取修改中的配置文件. Kubernetes会等待ConfigMap修改完毕后将新的文件写入新的文件夹中, 并relink到新的文件夹中. 注意: 如果在container中使用<strong>subPath</strong>而不是mount整个volume, 则文件无法随着ConfigMap的修改而刷新.<br>若Pod中的container不支持自动检查ConfigMap是否被修改, 则不建议修改当前ConfigMap. 因为Pod随时可能被重新启动, 重启后的container会使用新的配置信息, 而旧的container还会使用旧的配置信息.</p>
<h2 id="5-Screts"><a href="#5-Screts" class="headerlink" title="5. Screts"></a>5. Screts</h2><p>ConfigMap已经为container提供了完整的配置获取方案, 但有时需要存储一些敏感信息, 如: 秘钥, 证书. 为此Kubernetes提供Secrets, 可通过两种方式来获取信息:</p>
<ol>
<li>将Secret entry作为environment variables传入container</li>
<li>将Secret entry作为volume挂在Pod上</li>
</ol>
<h3 id="5-1-default-token-Secret"><a href="#5-1-default-token-Secret" class="headerlink" title="5.1 default token Secret"></a>5.1 default token Secret</h3><p>为保证Secret的安全性, Secret永远不会写入物理存储设备, 只会保留在内存中. 每个Pod都会自带一些Secret, 可通过调用<strong>kubectl describe pod</strong> command来查看Pod绑定了哪些Secret:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod &lt;pod_name&gt;</span><br><span class="line">...</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-t75t5:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-t75t5</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>也可通过<strong>kubectl get secrets</strong> command来查看当前namespace下的所有secrets:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl get secrets</span><br><span class="line">NAME                TYPE                                DATA AGE</span><br><span class="line">default-token-t75t5 kubernetes.io/service-account-token 3    1d</span><br></pre></td></tr></table></figure>
<p>若需要查看某个secret的具体信息, 可调用<strong>kubectl describe secret</strong>:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl describe secret default-token-t75t5</span><br><span class="line">Name:         default-token-t75t5</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: default</span><br><span class="line">              kubernetes.io/service-account.uid: 0e856e7b-dfa3-11e9-8f93-4a00e35c70a2</span><br><span class="line">Type:         kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:       1873 bytes</span><br><span class="line">namespace:    7 bytes</span><br><span class="line">token:        eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9...</span><br></pre></td></tr></table></figure>
<p>其中<strong>ca.crt</strong>和<strong>token</strong>是为了让Pod与Kubernetes API server进行安全通信. 该Secret作为volume会被挂靠在Pod的**&#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount**路径上.</p>
<h3 id="5-2-Create-a-Secret"><a href="#5-2-Create-a-Secret" class="headerlink" title="5.2 Create a Secret"></a>5.2 Create a Secret</h3><p>以之前的Nginx container为例, 可通过Secret在container中配置certificate和private key来让Nginx支持HTTPS. 首先需要生成certificate和private key并将其放置文件之中:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ openssl genrsa -out https.key 2048</span><br><span class="line">$ openssl req -new -x509 -key https.key -out https.cert -days 3650 \ </span><br><span class="line">-subj CN=www.kubia-example.com</span><br></pre></td></tr></table></figure>
<p>为更好的表现Secret的性质, 再添加另外一个文件:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> bar &gt; foo</span><br></pre></td></tr></table></figure>
<p>最后通过<strong>kubectl create secret</strong> command来创建一个Secret:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ kubectl create secret generic fortune-https --from-file=https.key \</span><br><span class="line">--from-file=https.cert --from-file=foo</span><br><span class="line">secret <span class="string">&quot;fortune-https&quot;</span> created</span><br></pre></td></tr></table></figure>

<h3 id="5-3-Compare-ConfigMap-and-Secret"><a href="#5-3-Compare-ConfigMap-and-Secret" class="headerlink" title="5.3 Compare ConfigMap and Secret"></a>5.3 Compare ConfigMap and Secret</h3><p>虽然ConfigMap和Secret都是ky-value的map格式, 但其实存在很大差异:</p>
<ol>
<li>Secret entry中的key依然是明文形式, 但value使用Base43-encoded形式编码</li>
<li>Secret支持二进制数据, 因为Base64可对二进制数据进行编码</li>
<li>Secret支持stringData属性来放置该entry的value被Base64编码</li>
<li>当Secret的entry被当做environment variable或volume时, entry会被自动解码, 因此container内的进程无需解码操作</li>
</ol>
<h3 id="5-4-Use-the-Secret-in-a-Pod"><a href="#5-4-Use-the-Secret-in-a-Pod" class="headerlink" title="5.4 Use the Secret in a Pod"></a>5.4 Use the Secret in a Pod</h3><p>为了让Nginx支持HTTPS, 需要将secret中的certificate和private key传给Nginx:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fortune-https</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">luksa/fortune:env</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">html-generator</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INTERVAL</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">fortune-config</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">sleep-interval</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/var/htdocs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-server</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/nginx/conf.d</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">certs</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/nginx/certs/</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">fortune-config</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">my-nginx-config.conf</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">https.conf</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">certs</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">fortune-https</span></span><br></pre></td></tr></table></figure>
<p>结果如下:<br><img src="/images/Kubernetes/config-8.png" alt="Combine a ConfigMap and a Secret to run your fortune-https pod"></p>
<p>也可以将Secret entry写入environment variable中:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FOO_SECRET</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">secretKeyRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">fortune-https</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">foo</span> </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
    </div>

    <footer class="post-footer">
      
      <div class="post-tags">
        
          <a href="/tags/K8s/">K8s</a>
        
      </div>
      

      
      
  <nav class="post-nav">
    
      <a class="prev" href="/p/a0f1.html">
        <i class="icon-left"></i>
        <span class="prev-text nav-default">Access Pod Metadata</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/p/f56f.html">
        <span class="next-text nav-default">Volumes</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="icon-right"></i>
      </a>
    
  </nav>

      
    </footer>
  </article>

  </div>
  
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    showProcessingMessages: true,
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: false,
        skipTags: ["script","noscript","style","textarea"]
    },
    TeX: {
        Macros:{
            Arr: ["\\{ #1 \\}", 1],
            fi: "{f\\,\\!_i}",
            SS: ["{#1\\:\\!_#2}",2],
            SUBx: ["{\\:\\!_#1}",1],
            EXPx: ["{\\;\\!^#1}",1],
            Ss: ["{#1\\,\\!_#2}",2],
            subx: ["{\\,\\!_#1}",1]
        }
    }
});
</script>


      </div>
    </div>

    
<script type="text/javascript">
  var disqus_shortname = 'zaf1ro';
  var disqus_identifier = 'p/95.html';
  var disqus_title = "ConfigMap and Secret";

  var disqus = {
    load : function disqus(){
        if(typeof DISQUS !== 'object') {
          (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
          }());
          $('#load-disqus').remove(); ///加载后移除按钮
        }
    }
  }

  
    var disqus_config = function () {
        this.page.url = disqus_url;
        this.page.identifier = disqus_identifier;
        this.page.title = disqus_title;
    };
  

</script>



    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.6.0.min.js"></script>
  

  

    
    <script type="text/javascript">
(function(){"use strict";var Theme={};Theme.backToTop={register:function(){var $backToTop=$('#back-to-top');$(window).scroll(function(){if($(window).scrollTop()>100){$backToTop.fadeIn(1000)}else{$backToTop.fadeOut(1000)}});$backToTop.click(function(){$('body').animate({scrollTop:0})})}};Theme.fancybox={register:function(){if($.fancybox){$('.post').each(function(){$(this).find('img').each(function(){$(this).wrap('<a class="fancybox" href="'+this.src+'" title="'+this.alt+'"></a>')})});$('.fancybox').fancybox({openEffect:'elastic',closeEffect:'elastic'})}}};this.Theme=Theme}.call(this));
</script>

<script type="text/javascript">
$(document).ready(function(){if(themeConfig.fancybox.enable){Theme.fancybox.register()}Theme.backToTop.register()});
</script>
    
<script type="text/javascript">
var themeConfig = {
  fancybox: {
    enable: false
  },
};
</script>

    <script>
    $('table').wrap('<div style="overflow-x: auto;"></div>');
</script>
    
    <script>
$(document).ready(function () {
    $('#sidebarCollapse').on('click', function(){
        $('#sidebar').toggleClass('active');
    });

    $('#toc ol li a').on('click', function(){
        $('#sidebar').toggleClass('active');
    });
});
</script>
  </body>
</html>
